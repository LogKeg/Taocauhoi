<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tạo đề online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="hero">
      <div>
        <h1>Tạo câu hỏi tự động</h1>
        <p>Tạo câu hỏi tương tự từ mẫu, hoặc sinh câu hỏi theo chủ đề.</p>
        <p class="build" id="buildInfo"></p>
      </div>
    </header>

    <div class="app-layout">
      <nav class="sidebar">
        <button class="nav-item active" data-tab="tab-create">Tạo đề từ đề mẫu</button>
        <button class="nav-item" data-tab="tab-topic">Tạo theo chủ đề (AI)</button>
        <button class="nav-item" data-tab="tab-convert">Word → Excel</button>
        <button class="nav-item" data-tab="tab-bank">Ngân hàng câu hỏi</button>
        <button class="nav-item" data-tab="tab-history">Lịch sử sử dụng</button>
        <button class="nav-item" data-tab="tab-grading">Chấm bài (OMR)</button>
        <button class="nav-item" data-tab="tab-handwritten">Chấm bài (Viết tay)</button>
        <button class="nav-item" data-tab="tab-settings">Cài đặt</button>
        <button class="nav-item" data-tab="tab-blob" id="navBlob" hidden>Quản lý Blob</button>
      </nav>

      <main class="content">
        <!-- Tab: Tạo đề từ đề mẫu -->
        <section class="tab-panel active" id="tab-create">
          <div class="panel">
            <h2>Tạo đề từ đề mẫu</h2>
            <p>Upload file Word (.docx) chứa đề mẫu để tạo đề mới tương tự theo từng câu.</p>
            <div class="upload-area">
              <input type="file" id="createFile" accept=".docx" />
              <button id="parseFileBtn" type="button">Phân tích đề</button>
            </div>
            <div class="parse-info" id="parseInfo" hidden>
              <p><strong>Đề mẫu:</strong> <span id="parseFileName"></span> - <span id="parseQuestionCount">0</span> câu hỏi</p>
            </div>
            <div class="create-options">
              <div class="auto-grid">
                <div>
                  <label for="createSubject">Môn học</label>
                  <select id="createSubject">
                    <option value="auto">Tự động nhận dạng</option>
                    <option value="science">Khoa học / Science</option>
                    <option value="math">Toán / Math</option>
                    <option value="english">Tiếng Anh / English</option>
                    <option value="history">Lịch sử / History</option>
                    <option value="geography">Địa lý / Geography</option>
                  </select>
                </div>
                <div>
                  <label for="createDifficulty">Độ khó so với đề mẫu</label>
                  <select id="createDifficulty">
                    <option value="same">Tương đương</option>
                    <option value="easier">Dễ hơn</option>
                    <option value="harder">Khó hơn</option>
                  </select>
                </div>
                <div>
                  <label for="createBilingual">Ngôn ngữ</label>
                  <select id="createBilingual">
                    <option value="auto">Tự động nhận dạng</option>
                    <option value="bilingual">Song ngữ (EN-VIE)</option>
                    <option value="english">Chỉ tiếng Anh</option>
                    <option value="vietnamese">Chỉ tiếng Việt</option>
                  </select>
                </div>
                <div>
                  <label for="createEngine">AI Engine</label>
                  <select id="createEngine"></select>
                </div>
                <button id="createBtn" type="button">Tạo đề mới</button>
              </div>
            </div>
            <div class="gen-status" id="createStatus"></div>
          </div>
          <div class="panel result-panel" id="createResult" hidden>
            <div class="output-header">
              <h2>Đề mới (<span id="createResultCount">0</span> câu)</h2>
              <div class="actions">
                <button id="createExportDocx">Xuất DOCX</button>
                <button id="createExportPdf">Xuất PDF</button>
                <button id="createSaveHistory">Lưu lịch sử</button>
              </div>
            </div>
            <div class="create-output" id="createOutput"></div>
          </div>
        </section>

        <section class="tab-panel" id="tab-topic">
          <div class="panel">
            <h2>Tạo theo chủ đề (AI)</h2>
            <div class="auto-grid">
              <div>
                <label for="topicSubject">Môn học</label>
                <select id="topicSubject"></select>
              </div>
              <div>
                <label for="topicTopic">Chủ đề</label>
                <select id="topicTopic"><option value="">-- Tất cả --</option></select>
              </div>
              <div>
                <label for="topicGrade">Lớp</label>
                <select id="topicGrade"></select>
              </div>
              <div>
                <label for="topicType">Dạng câu hỏi</label>
                <select id="topicType"></select>
              </div>
              <div>
                <label for="topicCount">Số câu</label>
                <input id="topicCount" type="number" min="1" max="50" value="10" />
              </div>
              <div>
                <label for="topicDifficulty">Độ khó</label>
                <select id="topicDifficulty">
                  <option value="easy">Dễ</option>
                  <option value="medium" selected>Trung bình</option>
                  <option value="hard">Khó</option>
                </select>
              </div>
              <div>
                <label for="topicEngine">AI Engine</label>
                <select id="topicEngine"></select>
              </div>
              <button id="topicGenerate" type="button">Tạo theo chủ đề</button>
            </div>
            <small>AI sẽ tự tạo câu hỏi theo môn, lớp và dạng câu hỏi bạn chọn.</small>
          </div>
          <div class="panel result-panel" id="topicResult" hidden>
            <div class="output-header">
              <h2>Kết quả</h2>
              <div class="actions">
                <button data-export="txt">Xuất TXT</button>
                <button data-export="csv">Xuất CSV</button>
                <button data-export="docx">Xuất DOCX</button>
                <button data-export="pdf">Xuất PDF</button>
              </div>
            </div>
            <div class="gen-status" id="topicStatus"></div>
            <ol class="output-list" id="topicOutput"></ol>
            <div class="answers-section" id="topicAnswers" hidden>
              <button class="toggle-answers" id="toggleAnswers">Hiện đáp án</button>
              <div class="answers-content" id="answersContent" hidden></div>
            </div>
          </div>
        </section>

        <!-- Tab: Word to Excel -->
        <section class="tab-panel" id="tab-convert">
          <div class="panel">
            <h2>Chuyển đổi Word sang Excel</h2>
            <p>Upload file Word (.docx) chứa câu hỏi để xuất ra file Excel.</p>
            <div class="upload-area">
              <input type="file" id="convertFile" accept=".docx" />
              <button id="convertBtn" type="button">Chuyển đổi</button>
            </div>
            <div class="convert-options" style="margin-top: 12px; text-align: left;">
              <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="convertLatex" style="width: auto;" />
                <span>Xuất công thức dạng LaTeX</span>
              </label>
            </div>
            <div class="gen-status" id="convertStatus"></div>
          </div>
        </section>

        <!-- Tab: Question Bank -->
        <section class="tab-panel" id="tab-bank">
          <div class="panel">
            <h2>Ngân hàng câu hỏi</h2>
            <div class="bank-filters">
              <select id="bankSubject">
                <option value="">Tất cả môn</option>
              </select>
              <select id="bankDifficulty">
                <option value="">Tất cả độ khó</option>
                <option value="easy">Dễ</option>
                <option value="medium">Trung bình</option>
                <option value="hard">Khó</option>
              </select>
              <input type="text" id="bankSearch" placeholder="Tìm kiếm..." />
              <button id="bankSearchBtn">Tìm</button>
              <button id="bankRefreshBtn">Làm mới</button>
            </div>
            <div class="bank-stats" id="bankStats"></div>
          </div>
          <div class="panel">
            <div class="output-header">
              <h3>Danh sách câu hỏi (<span id="bankTotal">0</span>)</h3>
              <div class="actions">
                <button id="addQuestionBtn">+ Thêm câu hỏi</button>
              </div>
            </div>
            <div class="bank-list" id="bankList"></div>
            <div class="bank-pagination" id="bankPagination"></div>
          </div>
        </section>

        <!-- Tab: Lịch sử sử dụng -->
        <section class="tab-panel" id="tab-history">
          <div class="panel">
            <h2>Lịch sử sử dụng</h2>
            <div class="history-actions">
              <button id="historyRefreshBtn">Làm mới</button>
              <button id="historyClearBtn">Xóa tất cả</button>
            </div>
            <div class="gen-status" id="historyStatus"></div>
          </div>
          <div class="panel">
            <div class="history-list" id="historyList">
              <p>Chưa có lịch sử.</p>
            </div>
          </div>
        </section>

        <!-- Tab: Chấm bài trắc nghiệm -->
        <section class="tab-panel" id="tab-grading">
          <div class="panel">
            <h2>Chấm bài trắc nghiệm</h2>
            <p>Upload ảnh phiếu trả lời đã scan/chụp để chấm điểm tự động.</p>

            <div class="auto-grid" style="margin-bottom: 1rem;">
              <div>
                <label for="gradingContest">Kỳ thi</label>
                <select id="gradingContest">
                  <option value="KANGAROO">Kangaroo</option>
                  <option value="ASMO">ASMO</option>
                  <option value="SEAMO">SEAMO</option>
                </select>
              </div>
              <div>
                <label for="gradingSubject">Môn thi</label>
                <select id="gradingSubject">
                  <!-- Options will be populated by JavaScript based on contest -->
                </select>
              </div>
              <div>
                <label for="gradingLevel">Cấp độ</label>
                <select id="gradingLevel">
                  <!-- Options will be populated by JavaScript based on contest and subject -->
                </select>
              </div>
            </div>
            <!-- Hidden field to store the combined template value -->
            <input type="hidden" id="gradingTemplate" value="KANGAROO_SCIENCE_BENJAMIN">

            <div class="grading-section">
              <h3>Bước 1: Nhập đáp án đúng</h3>
              <div class="answer-input-tabs">
                <button type="button" class="answer-tab active" data-mode="manual">Nhập thủ công</button>
                <button type="button" class="answer-tab" data-mode="excel">Upload file (Excel/PDF)</button>
              </div>

              <div id="manualAnswerInput">
                <p style="margin: 0.5rem 0; color: var(--muted);">Chọn đáp án đúng cho từng câu (A-E):</p>
                <div class="answer-grid" id="answerGrid"></div>
              </div>

              <div id="excelAnswerInput" hidden>
                <p style="margin: 0.5rem 0; color: var(--muted);">Upload file Excel, Word hoặc PDF chứa đáp án</p>
                <input type="file" id="answerExcelFile" accept=".xlsx,.xls,.pdf,.docx,.doc" />
                <span id="answerFileStatus" style="margin-left: 0.5rem;"></span>
              </div>
            </div>

            <div class="grading-section" style="margin-top: 1.5rem;">
              <h3>Bước 2: Upload phiếu trả lời</h3>
              <p style="margin: 0.5rem 0; color: var(--muted);">Hỗ trợ ảnh (JPG, PNG) hoặc PDF (mỗi trang = 1 phiếu)</p>
              <div class="upload-area">
                <input type="file" id="sheetImages" accept="image/*,.pdf" multiple />
                <span id="sheetCount" style="margin-left: 0.5rem;">0 file đã chọn</span>
              </div>
            </div>

            <div style="margin-top: 1.5rem;">
              <button id="gradeBtn" type="button" class="primary-btn">Chấm bài</button>
            </div>
            <div class="gen-status" id="gradingStatus"></div>
          </div>

          <div class="panel result-panel" id="gradingResult" hidden>
            <div class="output-header">
              <h2>Kết quả chấm bài</h2>
              <div class="actions">
                <button id="exportGradingExcel">Xuất Excel</button>
              </div>
            </div>
            <div class="grading-summary" id="gradingSummary"></div>
            <div class="grading-table-container">
              <table class="grading-table" id="gradingTable">
                <thead>
                  <tr>
                    <th>STT</th>
                    <th>Họ và tên</th>
                    <th>Lớp</th>
                    <th>SBD</th>
                    <th>Trường</th>
                    <th>Điểm</th>
                    <th>Đúng</th>
                    <th>Sai</th>
                    <th>Bỏ trống</th>
                    <th>Chi tiết</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Tab: Chấm bài viết tay -->
        <section class="tab-panel" id="tab-handwritten">
          <div class="panel">
            <h2>Chấm bài viết tay</h2>
            <p>Upload ảnh phiếu trả lời có đáp án viết tay (A, B, C, D, E) để chấm điểm tự động.</p>

            <div class="auto-grid" style="margin-bottom: 1rem;">
              <div>
                <label for="hwNumQuestions">Số câu hỏi</label>
                <input type="number" id="hwNumQuestions" value="30" min="1" max="100" />
              </div>
              <div>
                <label for="hwValidAnswers">Đáp án hợp lệ</label>
                <input type="text" id="hwValidAnswers" value="A,B,C,D,E" placeholder="A,B,C,D,E" />
              </div>
            </div>

            <div class="auto-grid" style="margin-bottom: 1rem;">
              <div>
                <label for="hwScoringCorrect">Điểm đúng</label>
                <input type="number" id="hwScoringCorrect" value="1" step="0.25" />
              </div>
              <div>
                <label for="hwScoringWrong">Điểm sai</label>
                <input type="number" id="hwScoringWrong" value="0" step="0.25" />
              </div>
              <div>
                <label for="hwScoringBlank">Điểm bỏ trống</label>
                <input type="number" id="hwScoringBlank" value="0" step="0.25" />
              </div>
            </div>

            <div class="grading-section">
              <h3>Bước 1: Nhập đáp án đúng</h3>
              <div class="answer-input-tabs">
                <button type="button" class="hw-answer-tab active" data-mode="manual">Nhập thủ công</button>
                <button type="button" class="hw-answer-tab" data-mode="text">Nhập dạng text</button>
              </div>

              <div id="hwManualAnswerInput">
                <p style="margin: 0.5rem 0; color: var(--muted);">Chọn đáp án đúng cho từng câu:</p>
                <div class="answer-grid" id="hwAnswerGrid"></div>
              </div>

              <div id="hwTextAnswerInput" hidden>
                <p style="margin: 0.5rem 0; color: var(--muted);">Nhập đáp án cách nhau bằng dấu phẩy (VD: A,B,C,D,A,B,...)</p>
                <textarea id="hwAnswerText" rows="3" placeholder="A,B,C,D,E,A,B,C,D,E,..."></textarea>
              </div>
            </div>

            <div class="grading-section" style="margin-top: 1.5rem;">
              <h3>Bước 2: Upload phiếu trả lời</h3>
              <p style="margin: 0.5rem 0; color: var(--muted);">Upload ảnh chứa đáp án viết tay của học sinh</p>
              <div class="upload-area">
                <input type="file" id="hwSheetImages" accept="image/*" multiple />
                <span id="hwSheetCount" style="margin-left: 0.5rem;">0 file đã chọn</span>
              </div>
            </div>

            <div style="margin-top: 1.5rem;">
              <button id="hwGradeBtn" type="button" class="primary-btn">Chấm bài</button>
            </div>
            <div class="gen-status" id="hwGradingStatus"></div>
          </div>

          <div class="panel result-panel" id="hwGradingResult" hidden>
            <div class="output-header">
              <h2>Kết quả chấm bài viết tay</h2>
              <div class="actions">
                <button id="hwExportExcel">Xuất Excel</button>
              </div>
            </div>
            <div class="grading-summary" id="hwGradingSummary"></div>
            <div class="grading-table-container">
              <table class="grading-table" id="hwGradingTable">
                <thead>
                  <tr>
                    <th>STT</th>
                    <th>Tên file</th>
                    <th>Điểm</th>
                    <th>Đúng</th>
                    <th>Sai</th>
                    <th>Bỏ trống</th>
                    <th>Chi tiết</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="tab-panel" id="tab-settings">
          <div class="panel">
            <h2>Cài đặt AI</h2>
            <div class="settings-grid">
              <fieldset class="settings-group">
                <legend>OpenAI</legend>
                <label for="setOpenaiKey">API Key</label>
                <input id="setOpenaiKey" type="password" placeholder="sk-..." autocomplete="off" />
                <label for="setOpenaiModel">Model</label>
                <input id="setOpenaiModel" type="text" placeholder="gpt-4o-mini" />
                <label for="setOpenaiBase">API Base URL</label>
                <input id="setOpenaiBase" type="text" placeholder="https://api.openai.com/v1" />
              </fieldset>
              <fieldset class="settings-group">
                <legend>Google Gemini</legend>
                <label for="setGeminiKey">API Key</label>
                <input id="setGeminiKey" type="password" placeholder="AIza..." autocomplete="off" />
                <label for="setGeminiModel">Model</label>
                <input id="setGeminiModel" type="text" placeholder="gemini-2.0-flash" />
              </fieldset>
              <fieldset class="settings-group">
                <legend>Ollama (local)</legend>
                <label for="setOllamaBase">Base URL</label>
                <input id="setOllamaBase" type="text" placeholder="http://localhost:11434" />
                <label for="setOllamaModel">Model</label>
                <input id="setOllamaModel" type="text" placeholder="llama3.2" />
              </fieldset>
            </div>
            <div class="settings-actions">
              <button id="saveSettings" type="button">Lưu cài đặt</button>
              <span id="settingsStatus" class="gen-status"></span>
            </div>
            <div class="engine-status" id="engineStatus"></div>
          </div>
        </section>

        <section class="tab-panel" id="tab-blob">
          <div class="panel" id="blobManager" hidden>
            <div class="output-header">
              <h2>Quản lý đề mẫu (Blob)</h2>
              <div class="actions">
                <button id="refreshBlob">Làm mới</button>
                <button id="exportBlobCsv">Xuất CSV</button>
              </div>
            </div>
            <div class="blob-meta">
              <span id="blobCount">0 file</span>
              <span id="blobSize">0 KB</span>
            </div>
            <div class="blob-list" id="blobList"></div>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal xem chi tiết lịch sử -->
    <div class="modal-overlay" id="historyModal" hidden>
      <div class="modal">
        <div class="modal-header">
          <h2 id="modalTitle">Chi tiết</h2>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
          <button id="modalExportDocx">Xuất DOCX</button>
          <button id="modalExportPdf">Xuất PDF</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { upload } from 'https://esm.sh/@vercel/blob/client';

      /* ---- Tab switching ---- */
      const navItems = document.querySelectorAll('.nav-item');
      const tabPanels = document.querySelectorAll('.tab-panel');
      const navBlob = document.getElementById('navBlob');

      function switchTab(tabId) {
        navItems.forEach((btn) => btn.classList.toggle('active', btn.dataset.tab === tabId));
        tabPanels.forEach((p) => p.classList.toggle('active', p.id === tabId));
      }
      navItems.forEach((btn) => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      const blobManager = document.getElementById('blobManager');
      const blobList = document.getElementById('blobList');
      const blobCount = document.getElementById('blobCount');
      const blobSize = document.getElementById('blobSize');
      const buildInfo = document.getElementById('buildInfo');
      const topicSubject = document.getElementById('topicSubject');
      const topicGrade = document.getElementById('topicGrade');
      const topicType = document.getElementById('topicType');

      let currentQuestions = [];
      let createdQuestions = [];
      let useBlob = false;
      let blobIndex = {};
      let activeEngine = 'ollama';
      let subjectTopics = {};
      let usageHistory = JSON.parse(localStorage.getItem('usageHistory') || '[]');

      async function loadSubjects() {
        const res = await fetch('/subjects');
        const data = await res.json();
        subjectTopics = data.topics || {};
        topicSubject.innerHTML = (data.subjects || [])
          .map((s) => `<option value="${s.key}">${s.label}</option>`)
          .join('');
        topicType.innerHTML = (data.question_types || [])
          .map((t) => `<option value="${t.key}">${t.label}</option>`)
          .join('');
        topicGrade.innerHTML = (data.grades || [])
          .map((g) => `<option value="${g}">${g}</option>`)
          .join('');
        updateTopicTopics();
      }

      function updateTopicTopics() {
        const topics = subjectTopics[topicSubject.value] || [];
        const topicSelect = document.getElementById('topicTopic');
        topicSelect.innerHTML = '<option value="">-- Tất cả --</option>' +
          topics.map((t) => `<option value="${t.key}">${t.label}</option>`).join('');
      }

      topicSubject.addEventListener('change', updateTopicTopics);

      async function loadBuildInfo() {
        try {
          const res = await fetch('/version');
          const data = await res.json();
          if (data.commit) {
            buildInfo.textContent = `Build: ${data.commit.slice(0, 7)}`;
          }
        } catch (err) {
          buildInfo.textContent = '';
        }
      }

      async function loadEngines() {
        const res = await fetch('/ai-engines');
        const data = await res.json();
        const engines = data.engines || [];
        // Ưu tiên ollama nếu available, nếu không thì chọn engine available đầu tiên
        const ollama = engines.find((e) => e.key === 'ollama' && e.available);
        const first = engines.find((e) => e.available);
        if (ollama) activeEngine = 'ollama';
        else if (first) activeEngine = first.key;
        renderEngineStatus(engines);
        renderEngineSelects(engines);
      }

      function renderEngineSelects(engines) {
        const available = engines.filter((e) => e.available);
        const html = available
          .map((e) => `<option value="${e.key}"${e.key === activeEngine ? ' selected' : ''}>${e.label}</option>`)
          .join('');
        document.getElementById('createEngine').innerHTML = html || '<option value="">Không có AI</option>';
        document.getElementById('topicEngine').innerHTML = html || '<option value="">Không có AI</option>';
      }

      function renderEngineStatus(engines) {
        const el = document.getElementById('engineStatus');
        el.innerHTML = '<h3>Trạng thái kết nối</h3>' + engines
          .map((e) => {
            const dot = e.available ? '<span class="dot dot-ok"></span>' : '<span class="dot dot-off"></span>';
            return `<div class="engine-row">${dot} ${e.label}</div>`;
          })
          .join('');
      }

      /* ---- Settings ---- */
      async function loadSettings() {
        const res = await fetch('/ai-settings');
        const s = await res.json();
        document.getElementById('setOpenaiKey').placeholder = s.openai_key || 'sk-...';
        document.getElementById('setOpenaiModel').placeholder = s.openai_model;
        document.getElementById('setOpenaiBase').placeholder = s.openai_base;
        document.getElementById('setGeminiKey').placeholder = s.gemini_key || 'AIza...';
        document.getElementById('setGeminiModel').placeholder = s.gemini_model;
        document.getElementById('setOllamaBase').placeholder = s.ollama_base;
        document.getElementById('setOllamaModel').placeholder = s.ollama_model;
      }

      document.getElementById('saveSettings').addEventListener('click', async () => {
        const status = document.getElementById('settingsStatus');
        status.textContent = 'Đang lưu...';
        const payload = {};
        const fields = [
          ['setOpenaiKey', 'openai_key'],
          ['setOpenaiModel', 'openai_model'],
          ['setOpenaiBase', 'openai_base'],
          ['setGeminiKey', 'gemini_key'],
          ['setGeminiModel', 'gemini_model'],
          ['setOllamaBase', 'ollama_base'],
          ['setOllamaModel', 'ollama_model'],
        ];
        fields.forEach(([id, key]) => {
          const val = document.getElementById(id).value.trim();
          if (val) payload[key] = val;
        });
        await fetch('/ai-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        // Clear inputs after saving
        fields.forEach(([id]) => { document.getElementById(id).value = ''; });
        await loadSettings();
        await loadEngines();
        status.textContent = 'Đã lưu!';
        setTimeout(() => { status.textContent = ''; }, 2000);
      });

      /* ---- Blob ---- */
      async function fetchBlobList(prefix = '') {
        const url = prefix ? `/api/blob/list?prefix=${encodeURIComponent(prefix)}` : '/api/blob/list';
        const res = await fetch(url);
        if (!res.ok) return [];
        const data = await res.json();
        return data.blobs || [];
      }

      async function loadBlobIndex() {
        const blobs = await fetchBlobList();
        blobIndex = {};
        blobs.forEach((item) => {
          const pathname = item.pathname || '';
          const parts = pathname.split('/');
          if (parts.length < 2) return;
          const subject = parts[0];
          const file = parts.slice(1).join('/');
          if (!blobIndex[subject]) blobIndex[subject] = [];
          blobIndex[subject].push({ ...item, file });
        });
        renderBlobManager(blobs);
      }

      async function loadSampleFolders() {
        const res = await fetch('/sample-folders');
        const data = await res.json();
        const folders = data.folders || [];
        if (!folders.length) {
          useBlob = true;
          await loadBlobIndex();
          blobManager.hidden = false;
          navBlob.hidden = false;
          return;
        }
        useBlob = false;
        blobManager.hidden = true;
        navBlob.hidden = true;
      }

      /* ---- Render results inline ---- */
      function renderQuestions(questions, outputEl, statusEl, resultPanel) {
        currentQuestions = questions;
        outputEl.innerHTML = questions
          .map((q, i) => `<li><strong>Câu ${i + 1}.</strong> ${q.replace(/\n/g, '<br>')}</li>`)
          .join('');
        // Always keep panel visible so user can see error messages
        resultPanel.hidden = false;
      }

      /* ---- Export ---- */
      function attachExport(container) {
        container.querySelectorAll('[data-export]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            if (!currentQuestions.length) return;
            const formData = new FormData();
            formData.append('samples', currentQuestions.join('\n'));
            formData.append('topic', 'toan_hoc');
            formData.append('custom_keywords', '');
            formData.append('paraphrase', false);
            formData.append('change_numbers', false);
            formData.append('change_context', false);
            formData.append('variants_per_question', 1);
            formData.append('use_ai', false);
            formData.append('ai_engine', activeEngine);
            formData.append('fmt', btn.dataset.export);
            const res = await fetch('/export', { method: 'POST', body: formData });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `questions.${btn.dataset.export}`;
            a.click();
            URL.revokeObjectURL(url);
          });
        });
      }
      attachExport(document.getElementById('topicResult'));

      /* ---- Tạo đề từ đề mẫu ---- */
      let parsedSampleQuestions = [];

      // Parse file to get question count
      document.getElementById('parseFileBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('createFile');
        const status = document.getElementById('createStatus');
        const parseInfo = document.getElementById('parseInfo');

        if (!fileInput.files.length) {
          status.textContent = 'Vui lòng chọn file .docx';
          return;
        }

        status.textContent = 'Đang phân tích đề mẫu...';

        try {
          const formData = new FormData();
          formData.append('file', fileInput.files[0]);

          const res = await fetch('/api/parse-exam', { method: 'POST', body: formData });
          const data = await res.json();

          if (data.ok) {
            parsedSampleQuestions = data.questions || [];
            document.getElementById('parseFileName').textContent = data.filename;
            document.getElementById('parseQuestionCount').textContent = parsedSampleQuestions.length;
            parseInfo.hidden = false;
            status.textContent = `Đã phân tích: ${parsedSampleQuestions.length} câu hỏi`;
          } else {
            status.textContent = 'Lỗi: ' + (data.error || 'Không thể phân tích đề');
          }
        } catch (err) {
          status.textContent = 'Lỗi: ' + err.message;
        }
      });

      document.getElementById('createBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('createFile');
        const status = document.getElementById('createStatus');
        const result = document.getElementById('createResult');
        const output = document.getElementById('createOutput');
        const countEl = document.getElementById('createResultCount');
        const difficulty = document.getElementById('createDifficulty').value;

        if (!fileInput.files.length) {
          status.textContent = 'Vui lòng chọn file .docx';
          return;
        }

        status.textContent = 'Đang tạo đề mới (tương tự từng câu)...';
        result.hidden = true;

        try {
          const formData = new FormData();
          formData.append('file', fileInput.files[0]);
          formData.append('difficulty', difficulty);
          formData.append('subject', document.getElementById('createSubject').value);
          formData.append('bilingual', document.getElementById('createBilingual').value);
          formData.append('ai_engine', document.getElementById('createEngine').value || activeEngine);

          const res = await fetch('/api/generate-similar-exam', { method: 'POST', body: formData });
          const data = await res.json();

          if (data.ok) {
            createdQuestions = data.generated_questions || [];
            countEl.textContent = createdQuestions.length;
            output.innerHTML = createdQuestions.map((q, i) => `
              <div class="created-question">
                <div class="q-number">Câu ${i + 1}</div>
                <div class="q-content">${(q.content || '').replace(/\n/g, '<br>')}</div>
                <div class="q-options">${(q.options || []).map((o, j) => `<span>${String.fromCharCode(65 + j)}) ${o}</span>`).join(' ')}</div>
                <div class="q-answer">Đáp án: ${q.correct_answer || ''}</div>
              </div>
            `).join('');
            result.hidden = false;
            status.textContent = `Đã tạo ${createdQuestions.length} câu hỏi mới (${difficulty === 'same' ? 'tương đương' : difficulty === 'easier' ? 'dễ hơn' : 'khó hơn'})`;

            // Auto save to history
            saveToHistory({
              type: 'create',
              filename: fileInput.files[0].name,
              count: createdQuestions.length,
              difficulty: difficulty,
              questions: createdQuestions,
              timestamp: new Date().toISOString(),
            });
          } else {
            status.textContent = 'Lỗi: ' + (data.error || 'Không thể tạo đề');
          }
        } catch (err) {
          status.textContent = 'Lỗi: ' + err.message;
        }
      });

      document.getElementById('createExportDocx').addEventListener('click', async () => {
        if (!createdQuestions.length) return;
        const res = await fetch('/api/export-exam', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            questions: createdQuestions,
            format: 'docx',
            title: 'Đề thi'
          })
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'de_moi.docx';
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('createExportPdf').addEventListener('click', async () => {
        if (!createdQuestions.length) return;
        const res = await fetch('/api/export-exam', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            questions: createdQuestions,
            format: 'pdf',
            title: 'Đề thi'
          })
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'de_moi.pdf';
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('createSaveHistory').addEventListener('click', () => {
        if (!createdQuestions.length) return;
        const status = document.getElementById('createStatus');
        status.textContent = 'Đã lưu vào lịch sử!';
      });

      /* ---- Lịch sử sử dụng ---- */
      let currentModalQuestions = [];

      async function saveToHistory(item) {
        usageHistory.unshift(item);
        if (usageHistory.length > 50) usageHistory = usageHistory.slice(0, 50);
        localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
        // Sync to server
        try {
          await fetch('/api/history', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item)
          });
        } catch (e) { console.log('Server sync failed:', e); }
        renderHistory();
      }

      async function loadHistoryFromServer() {
        try {
          const res = await fetch('/api/history');
          const data = await res.json();
          if (data.history && data.history.length) {
            // Merge with localStorage, avoiding duplicates by timestamp
            const localTimestamps = new Set(usageHistory.map(h => h.timestamp));
            data.history.forEach(h => {
              if (!localTimestamps.has(h.timestamp)) {
                usageHistory.push(h);
              }
            });
            // Sort by timestamp descending
            usageHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            usageHistory = usageHistory.slice(0, 50);
            localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
          }
        } catch (e) { console.log('Load history from server failed:', e); }
      }

      function showHistoryModal(historyItem) {
        const modal = document.getElementById('historyModal');
        const title = document.getElementById('modalTitle');
        const body = document.getElementById('modalBody');

        const date = new Date(historyItem.timestamp).toLocaleString('vi-VN');
        const typeLabel = historyItem.type === 'create' ? 'Tạo đề' : historyItem.type === 'topic' ? 'Tạo theo chủ đề' : 'Khác';

        title.textContent = `${typeLabel} - ${date}`;

        const questions = historyItem.questions || [];
        currentModalQuestions = questions;

        if (!questions.length) {
          body.innerHTML = '<p>Không có câu hỏi.</p>';
        } else {
          body.innerHTML = questions.map((q, i) => {
            if (typeof q === 'string') {
              return `<div class="created-question">
                <div class="q-number">Câu ${i + 1}</div>
                <div class="q-content">${q.replace(/\n/g, '<br>')}</div>
              </div>`;
            }
            return `<div class="created-question">
              <div class="q-number">Câu ${i + 1}</div>
              <div class="q-content">${(q.content || '').replace(/\n/g, '<br>')}</div>
              <div class="q-options">${(q.options || []).map((o, j) => `<span>${String.fromCharCode(65 + j)}) ${o}</span>`).join(' ')}</div>
              ${q.correct_answer ? `<div class="q-answer">Đáp án: ${q.correct_answer}</div>` : ''}
            </div>`;
          }).join('');
        }

        modal.hidden = false;
      }

      function hideHistoryModal() {
        document.getElementById('historyModal').hidden = true;
        currentModalQuestions = [];
      }

      document.getElementById('modalClose').addEventListener('click', hideHistoryModal);
      document.getElementById('historyModal').addEventListener('click', (e) => {
        if (e.target.id === 'historyModal') hideHistoryModal();
      });

      document.getElementById('modalExportDocx').addEventListener('click', async () => {
        if (!currentModalQuestions.length) return;
        const samples = currentModalQuestions.map(q => typeof q === 'string' ? q : q.content).join('\n');
        const formData = new FormData();
        formData.append('samples', samples);
        formData.append('topic', 'history');
        formData.append('fmt', 'docx');
        const res = await fetch('/export', { method: 'POST', body: formData });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lich_su.docx';
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('modalExportPdf').addEventListener('click', async () => {
        if (!currentModalQuestions.length) return;
        const samples = currentModalQuestions.map(q => typeof q === 'string' ? q : q.content).join('\n');
        const formData = new FormData();
        formData.append('samples', samples);
        formData.append('topic', 'history');
        formData.append('fmt', 'pdf');
        const res = await fetch('/export', { method: 'POST', body: formData });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lich_su.pdf';
        a.click();
        URL.revokeObjectURL(url);
      });

      function renderHistory() {
        const list = document.getElementById('historyList');
        if (!usageHistory.length) {
          list.innerHTML = '<p>Chưa có lịch sử.</p>';
          return;
        }
        list.innerHTML = usageHistory.map((h, i) => {
          const date = new Date(h.timestamp).toLocaleString('vi-VN');
          let typeLabel = 'Khác';
          if (h.type === 'create') typeLabel = 'Tạo đề';
          else if (h.type === 'topic') typeLabel = 'Tạo theo chủ đề';
          else if (h.type === 'convert') typeLabel = 'Word → Excel';

          let diffLabel = '';
          if (h.difficulty) {
            if (h.difficulty === 'same') diffLabel = ' (Tương đương)';
            else if (h.difficulty === 'easier') diffLabel = ' (Dễ hơn)';
            else if (h.difficulty === 'harder') diffLabel = ' (Khó hơn)';
            else if (h.difficulty === 'easy') diffLabel = ' (Dễ)';
            else if (h.difficulty === 'medium') diffLabel = ' (Trung bình)';
            else if (h.difficulty === 'hard') diffLabel = ' (Khó)';
          }

          // Build info based on type
          let infoHtml = '';
          if (h.type === 'convert') {
            infoHtml = `<strong>File:</strong> ${h.filename || ''} → ${h.outputFilename || ''}${h.useLatex ? ' (LaTeX)' : ''}`;
          } else {
            if (h.filename) infoHtml += `<strong>File:</strong> ${h.filename} `;
            if (h.subject) infoHtml += `<strong>Môn:</strong> ${h.subject} `;
            if (h.topic) infoHtml += `<strong>Chủ đề:</strong> ${h.topic} `;
            if (h.count) infoHtml += `<strong>Số câu:</strong> ${h.count}`;
            infoHtml += diffLabel;
          }

          // Only show export buttons for types with questions
          const hasQuestions = h.questions && h.questions.length > 0;
          const exportButtons = hasQuestions ? `
            <button class="view-history" data-index="${i}">Xem</button>
            <button class="export-history-docx" data-index="${i}">DOCX</button>
            <button class="export-history-pdf" data-index="${i}">PDF</button>
          ` : '';

          return `
            <div class="history-item">
              <div class="history-meta">
                <span class="history-type">${typeLabel}</span>
                <span class="history-date">${date}</span>
              </div>
              <div class="history-info">${infoHtml}</div>
              <div class="history-item-actions">
                ${exportButtons}
                <button class="delete-history" data-index="${i}">Xóa</button>
              </div>
            </div>
          `;
        }).join('');

        list.querySelectorAll('.delete-history').forEach(btn => {
          btn.addEventListener('click', async () => {
            const idx = parseInt(btn.dataset.index);
            const item = usageHistory[idx];
            usageHistory.splice(idx, 1);
            localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
            // Delete from server
            if (item && item.timestamp) {
              try {
                await fetch(`/api/history/${encodeURIComponent(item.timestamp)}`, { method: 'DELETE' });
              } catch (e) { console.log('Delete from server failed:', e); }
            }
            renderHistory();
          });
        });

        list.querySelectorAll('.view-history').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index);
            const h = usageHistory[idx];
            if (h) showHistoryModal(h);
          });
        });

        list.querySelectorAll('.export-history-docx').forEach(btn => {
          btn.addEventListener('click', async () => {
            const idx = parseInt(btn.dataset.index);
            const h = usageHistory[idx];
            if (!h || !h.questions || !h.questions.length) return;
            const samples = h.questions.map(q => typeof q === 'string' ? q : q.content).join('\n');
            const formData = new FormData();
            formData.append('samples', samples);
            formData.append('topic', 'history');
            formData.append('fmt', 'docx');
            const res = await fetch('/export', { method: 'POST', body: formData });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lich_su_${idx + 1}.docx`;
            a.click();
            URL.revokeObjectURL(url);
          });
        });

        list.querySelectorAll('.export-history-pdf').forEach(btn => {
          btn.addEventListener('click', async () => {
            const idx = parseInt(btn.dataset.index);
            const h = usageHistory[idx];
            if (!h || !h.questions || !h.questions.length) return;
            const samples = h.questions.map(q => typeof q === 'string' ? q : q.content).join('\n');
            const formData = new FormData();
            formData.append('samples', samples);
            formData.append('topic', 'history');
            formData.append('fmt', 'pdf');
            const res = await fetch('/export', { method: 'POST', body: formData });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lich_su_${idx + 1}.pdf`;
            a.click();
            URL.revokeObjectURL(url);
          });
        });
      }

      document.getElementById('historyRefreshBtn').addEventListener('click', async () => {
        await loadHistoryFromServer();
        usageHistory = JSON.parse(localStorage.getItem('usageHistory') || '[]');
        renderHistory();
        document.getElementById('historyStatus').textContent = 'Đã đồng bộ với server';
      });

      document.getElementById('historyClearBtn').addEventListener('click', async () => {
        if (!confirm('Xóa toàn bộ lịch sử?')) return;
        // Clear from server
        try {
          await fetch('/api/history', { method: 'DELETE' });
        } catch (e) { console.log('Clear server history failed:', e); }
        usageHistory = [];
        localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
        renderHistory();
        document.getElementById('historyStatus').textContent = 'Đã xóa lịch sử';
      });

      /* ---- Toggle Answers ---- */
      document.getElementById('toggleAnswers').addEventListener('click', () => {
        const content = document.getElementById('answersContent');
        const btn = document.getElementById('toggleAnswers');
        content.hidden = !content.hidden;
        btn.textContent = content.hidden ? 'Hiện đáp án' : 'Ẩn đáp án';
      });

      /* ---- Topic Generate ---- */
      document.getElementById('topicGenerate').addEventListener('click', async () => {
        const statusEl = document.getElementById('topicStatus');
        const outputEl = document.getElementById('topicOutput');
        const resultPanel = document.getElementById('topicResult');
        statusEl.textContent = 'Đang tạo...';
        resultPanel.hidden = false;
        outputEl.innerHTML = '';

        try {
          const formData = new FormData();
          formData.append('subject', topicSubject.value);
          formData.append('topic', document.getElementById('topicTopic').value);
          formData.append('grade', topicGrade.value);
          formData.append('qtype', topicType.value);
          formData.append('count', document.getElementById('topicCount').value || 10);
          formData.append('difficulty', document.getElementById('topicDifficulty').value);
          formData.append('ai_engine', document.getElementById('topicEngine').value || activeEngine);
          const res = await fetch('/generate-topic', { method: 'POST', body: formData });
          const data = await res.json();
          statusEl.textContent = data.message || '';
          renderQuestions(data.questions || [], outputEl, statusEl, resultPanel);
          // Show answers if available
          const answersSection = document.getElementById('topicAnswers');
          const answersContent = document.getElementById('answersContent');
          if (data.answers) {
            answersContent.textContent = data.answers;
            answersContent.hidden = true;
            answersSection.hidden = false;
            document.getElementById('toggleAnswers').textContent = 'Hiện đáp án';
          } else {
            answersSection.hidden = true;
          }
          // Save to history
          if (data.questions && data.questions.length) {
            const subjectLabel = topicSubject.options[topicSubject.selectedIndex]?.text || topicSubject.value;
            const difficultyVal = document.getElementById('topicDifficulty').value;
            saveToHistory({
              type: 'topic',
              subject: subjectLabel,
              topic: document.getElementById('topicTopic').value,
              grade: topicGrade.value,
              count: data.questions.length,
              difficulty: difficultyVal,
              questions: data.questions.map(q => ({ content: q })),
              answers: data.answers || '',
              timestamp: new Date().toISOString(),
            });
          }
        } catch (err) {
          statusEl.textContent = 'Lỗi: ' + err.message;
        }
      });

      /* ---- Blob Manager ---- */
      function humanSize(bytes) {
        if (!bytes) return '0 KB';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let idx = 0;
        while (size >= 1024 && idx < units.length - 1) {
          size /= 1024;
          idx += 1;
        }
        return `${size.toFixed(size < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
      }

      function renderBlobManager(blobs) {
        if (!useBlob) return;
        const total = blobs.reduce((sum, b) => sum + (b.size || 0), 0);
        blobCount.textContent = `${blobs.length} file`;
        blobSize.textContent = humanSize(total);
        blobList.innerHTML = blobs
          .map((item) => {
            return `
              <div class="blob-row">
                <div class="blob-name">${item.pathname}</div>
                <div class="blob-size">${humanSize(item.size || 0)}</div>
                <button data-url="${item.url}" class="blob-del">Xóa</button>
              </div>`;
          })
          .join('');
        blobList.querySelectorAll('.blob-del').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const url = btn.dataset.url;
            await fetch('/api/blob/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url }),
            });
            await loadBlobIndex();
          });
        });
      }

      document.getElementById('refreshBlob').addEventListener('click', async () => {
        if (!useBlob) return;
        await loadBlobIndex();
      });

      document.getElementById('exportBlobCsv').addEventListener('click', async () => {
        if (!useBlob) return;
        const blobs = await fetchBlobList();
        const header = 'pathname,size,url';
        const rows = blobs.map((b) => `${b.pathname},${b.size || 0},${b.url}`);
        const content = [header, ...rows].join('\n');
        const blob = new Blob([content], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'blob_samples.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      /* ---- Word to Excel ---- */
      document.getElementById('convertBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('convertFile');
        const status = document.getElementById('convertStatus');
        const useLatex = document.getElementById('convertLatex').checked;

        if (!fileInput.files.length) {
          status.textContent = 'Vui lòng chọn file .docx';
          return;
        }

        status.textContent = 'Đang chuyển đổi...';

        try {
          const formData = new FormData();
          formData.append('file', fileInput.files[0]);
          formData.append('use_latex', useLatex ? '1' : '0');

          const res = await fetch('/convert-word-to-excel', { method: 'POST', body: formData });

          if (res.ok) {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const outputFilename = fileInput.files[0].name.replace('.docx', '.xlsx');
            a.download = outputFilename;
            a.click();
            URL.revokeObjectURL(url);
            status.textContent = 'Đã tải xuống file Excel!';
            // Save to history
            saveToHistory({
              type: 'convert',
              filename: fileInput.files[0].name,
              outputFilename: outputFilename,
              useLatex: useLatex,
              timestamp: new Date().toISOString(),
            });
          } else {
            const data = await res.json();
            status.textContent = 'Lỗi: ' + (data.detail || 'Không thể chuyển đổi');
          }
        } catch (err) {
          status.textContent = 'Lỗi: ' + err.message;
        }
      });

      /* ---- Question Bank ---- */
      let bankPage = 0;
      const bankLimit = 20;

      async function loadBankQuestions() {
        const subject = document.getElementById('bankSubject').value;
        const difficulty = document.getElementById('bankDifficulty').value;
        const search = document.getElementById('bankSearch').value;

        const params = new URLSearchParams();
        params.append('skip', bankPage * bankLimit);
        params.append('limit', bankLimit);
        if (subject) params.append('subject', subject);
        if (difficulty) params.append('difficulty', difficulty);
        if (search) params.append('search', search);

        try {
          const res = await fetch(`/api/questions?${params}`);
          const data = await res.json();

          document.getElementById('bankTotal').textContent = data.total || 0;

          const list = document.getElementById('bankList');
          list.innerHTML = (data.questions || []).map(q => `
            <div class="bank-item" data-id="${q.id}">
              <div class="bank-item-content">
                <strong>${q.subject || 'N/A'}</strong> -
                <span class="difficulty-${q.difficulty || 'medium'}">${q.difficulty || 'medium'}</span>
                <p>${(q.content || '').substring(0, 150)}...</p>
              </div>
              <div class="bank-item-actions">
                <button class="edit-q" data-id="${q.id}">Sửa</button>
                <button class="delete-q" data-id="${q.id}">Xóa</button>
              </div>
            </div>
          `).join('') || '<p>Không có câu hỏi nào.</p>';

          // Attach delete handlers
          list.querySelectorAll('.delete-q').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (!confirm('Xóa câu hỏi này?')) return;
              await fetch(`/api/questions/${btn.dataset.id}`, { method: 'DELETE' });
              loadBankQuestions();
            });
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function loadBankStats() {
        try {
          const res = await fetch('/api/questions/stats');
          const data = await res.json();
          const el = document.getElementById('bankStats');
          el.innerHTML = `<strong>Tổng: ${data.total || 0} câu hỏi</strong>`;
        } catch (err) {
          console.error(err);
        }
      }

      document.getElementById('bankSearchBtn').addEventListener('click', () => {
        bankPage = 0;
        loadBankQuestions();
      });
      document.getElementById('bankRefreshBtn').addEventListener('click', () => {
        bankPage = 0;
        loadBankQuestions();
        loadBankStats();
      });

      /* ---- Grading (Chấm bài) ---- */
      const gradingContest = document.getElementById('gradingContest');
      const gradingSubject = document.getElementById('gradingSubject');
      const gradingLevel = document.getElementById('gradingLevel');
      const gradingTemplate = document.getElementById('gradingTemplate');
      const answerGrid = document.getElementById('answerGrid');
      const sheetImages = document.getElementById('sheetImages');
      const sheetCount = document.getElementById('sheetCount');
      const gradeBtn = document.getElementById('gradeBtn');
      const gradingStatus = document.getElementById('gradingStatus');
      const gradingResult = document.getElementById('gradingResult');
      const gradingSummary = document.getElementById('gradingSummary');
      const gradingTable = document.getElementById('gradingTable');
      let gradingResults = [];

      // Contest configuration
      const contestConfig = {
        KANGAROO: {
          name: 'Kangaroo',
          subjects: {
            SCIENCE: {
              name: 'Khoa học',
              code: 'IKSC',
              levels: {
                PRE_ECOLIER: { name: 'Pre-Ecolier (Lớp 1-2)', questions: 24 },
                ECOLIER: { name: 'Ecolier (Lớp 3-4)', questions: 24 },
                BENJAMIN: { name: 'Benjamin (Lớp 5-6)', questions: 30 },
                CADET: { name: 'Cadet (Lớp 7-8)', questions: 30 },
                JUNIOR: { name: 'Junior (Lớp 9-10)', questions: 30 },
                STUDENT: { name: 'Student (Lớp 11-12)', questions: 30 }
              }
            },
            ENGLISH: {
              name: 'Tiếng Anh',
              code: 'IKLC',
              levels: {
                PRE_ECOLIER: { name: 'Pre-Ecolier (Lớp 1-2)', questions: 24 },
                ECOLIER: { name: 'Ecolier (Lớp 3-4)', questions: 30 },
                BENJAMIN: { name: 'Benjamin (Lớp 5-6)', questions: 50 },
                CADET: { name: 'Cadet (Lớp 7-8)', questions: 50 },
                JUNIOR: { name: 'Junior (Lớp 9-10)', questions: 50 },
                STUDENT: { name: 'Student (Lớp 11-12)', questions: 50 }
              }
            }
          }
        },
        ASMO: {
          name: 'ASMO',
          subjects: {
            MATH: {
              name: 'Toán',
              code: 'ASMO_MATH',
              levels: {
                GRADE_1: { name: 'Lớp 1', questions: 25 },
                GRADE_2: { name: 'Lớp 2', questions: 25 },
                GRADE_3: { name: 'Lớp 3', questions: 25 },
                GRADE_4: { name: 'Lớp 4', questions: 25 },
                GRADE_5: { name: 'Lớp 5', questions: 25 },
                GRADE_6: { name: 'Lớp 6', questions: 25 },
                GRADE_7: { name: 'Lớp 7', questions: 25 },
                GRADE_8: { name: 'Lớp 8', questions: 25 },
                GRADE_9: { name: 'Lớp 9', questions: 25 },
                GRADE_10: { name: 'Lớp 10', questions: 25 },
                GRADE_11: { name: 'Lớp 11', questions: 25 },
                GRADE_12: { name: 'Lớp 12', questions: 25 }
              }
            },
            SCIENCE: {
              name: 'Khoa học',
              code: 'ASMO_SCIENCE',
              levels: {
                GRADE_1: { name: 'Lớp 1', questions: 25 },
                GRADE_2: { name: 'Lớp 2', questions: 25 },
                GRADE_3: { name: 'Lớp 3', questions: 25 },
                GRADE_4: { name: 'Lớp 4', questions: 25 },
                GRADE_5: { name: 'Lớp 5', questions: 25 },
                GRADE_6: { name: 'Lớp 6', questions: 25 },
                GRADE_7: { name: 'Lớp 7', questions: 25 },
                GRADE_8: { name: 'Lớp 8', questions: 25 },
                GRADE_9: { name: 'Lớp 9', questions: 25 },
                GRADE_10: { name: 'Lớp 10', questions: 25 },
                GRADE_11: { name: 'Lớp 11', questions: 25 },
                GRADE_12: { name: 'Lớp 12', questions: 25 }
              }
            },
            ENGLISH: {
              name: 'Tiếng Anh',
              code: 'ASMO_ENGLISH',
              levels: {
                GRADE_1: { name: 'Lớp 1', questions: 25 },
                GRADE_2: { name: 'Lớp 2', questions: 25 },
                GRADE_3: { name: 'Lớp 3', questions: 25 },
                GRADE_4: { name: 'Lớp 4', questions: 25 },
                GRADE_5: { name: 'Lớp 5', questions: 25 },
                GRADE_6: { name: 'Lớp 6', questions: 25 },
                GRADE_7: { name: 'Lớp 7', questions: 25 },
                GRADE_8: { name: 'Lớp 8', questions: 25 },
                GRADE_9: { name: 'Lớp 9', questions: 25 },
                GRADE_10: { name: 'Lớp 10', questions: 25 },
                GRADE_11: { name: 'Lớp 11', questions: 25 },
                GRADE_12: { name: 'Lớp 12', questions: 25 }
              }
            }
          }
        },
        SEAMO: {
          name: 'SEAMO',
          subjects: {
            MATH: {
              name: 'Toán (20 TN + 5 Điền)',
              code: 'SEAMO_MATH',
              levels: {
                PAPER_A: { name: 'Paper A (Lớp 1-2)', questions: 25, mcq: 20, fill_in: 5 },
                PAPER_B: { name: 'Paper B (Lớp 3-4)', questions: 25, mcq: 20, fill_in: 5 },
                PAPER_C: { name: 'Paper C (Lớp 5-6)', questions: 25, mcq: 20, fill_in: 5 },
                PAPER_D: { name: 'Paper D (Lớp 7-8)', questions: 25, mcq: 20, fill_in: 5 },
                PAPER_E: { name: 'Paper E (Lớp 9-10)', questions: 25, mcq: 20, fill_in: 5 },
                PAPER_F: { name: 'Paper F (Lớp 11-12)', questions: 25, mcq: 20, fill_in: 5 }
              }
            }
          }
        }
      };

      // Template info (for backward compatibility)
      const templateInfo = {};

      // Build templateInfo from contestConfig
      function buildTemplateInfo() {
        for (const [contestKey, contest] of Object.entries(contestConfig)) {
          for (const [subjectKey, subject] of Object.entries(contest.subjects)) {
            for (const [levelKey, level] of Object.entries(subject.levels)) {
              const templateKey = `${subject.code}_${levelKey}`;
              templateInfo[templateKey] = {
                questions: level.questions,
                name: `${subject.name} - ${level.name}`,
                contest: contestKey,
                subject: subjectKey,
                level: levelKey,
                mcq: level.mcq || level.questions,  // Số câu trắc nghiệm
                fill_in: level.fill_in || 0  // Số câu điền đáp án
              };
            }
          }
        }
        // Add custom option
        templateInfo['CUSTOM'] = { questions: 30, name: 'Tùy chỉnh', mcq: 30, fill_in: 0 };
      }
      buildTemplateInfo();

      // Update subject options based on contest
      function updateSubjectOptions() {
        const contest = gradingContest.value;
        const subjects = contestConfig[contest]?.subjects || {};

        gradingSubject.innerHTML = '';
        for (const [key, subject] of Object.entries(subjects)) {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = subject.name;
          gradingSubject.appendChild(option);
        }

        updateLevelOptions();
      }

      // Update level options based on contest and subject
      function updateLevelOptions() {
        const contest = gradingContest.value;
        const subject = gradingSubject.value;
        const levels = contestConfig[contest]?.subjects[subject]?.levels || {};

        gradingLevel.innerHTML = '';

        // Add auto-detect option first
        const autoOption = document.createElement('option');
        autoOption.value = 'AUTO';
        autoOption.textContent = 'Tự động nhận diện';
        gradingLevel.appendChild(autoOption);

        for (const [key, level] of Object.entries(levels)) {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${level.name} - ${level.questions} câu`;
          gradingLevel.appendChild(option);
        }

        updateTemplateValue();
      }

      // Update hidden template value
      function updateTemplateValue() {
        const contest = gradingContest.value;
        const subject = gradingSubject.value;
        const level = gradingLevel.value;
        const subjectConfig = contestConfig[contest]?.subjects[subject];

        if (level === 'AUTO') {
          // Auto-detect mode: use contest code with AUTO suffix
          gradingTemplate.value = 'AUTO';
        } else if (subjectConfig) {
          gradingTemplate.value = `${subjectConfig.code}_${level}`;
        }

        generateAnswerGrid();
      }

      // Event listeners for dropdowns
      gradingContest.addEventListener('change', updateSubjectOptions);
      gradingSubject.addEventListener('change', updateLevelOptions);
      gradingLevel.addEventListener('change', updateTemplateValue);

      // Initialize dropdowns
      updateSubjectOptions();

      // Generate answer grid
      function generateAnswerGrid() {
        const template = gradingTemplate.value;
        // For AUTO mode, show message instead of grid
        if (template === 'AUTO') {
          answerGrid.innerHTML = '<p style="color: var(--muted); font-style: italic;">Chế độ tự động: Hệ thống sẽ nhận diện môn và cấp độ từ phiếu trả lời. Vui lòng upload file đáp án (Excel/PDF) hoặc chọn cấp độ cụ thể để nhập thủ công.</p>';
          return;
        }

        const info = templateInfo[template] || { questions: 30 };
        const numQ = info.questions || 30;
        const mcqCount = info.mcq || numQ;  // Số câu trắc nghiệm
        const fillInCount = info.fill_in || 0;  // Số câu điền đáp án

        answerGrid.innerHTML = '';

        // Hiển thị hướng dẫn nếu có mixed format
        if (fillInCount > 0) {
          const note = document.createElement('p');
          note.style.cssText = 'color: var(--muted); font-style: italic; margin-bottom: 1rem;';
          note.textContent = `Gồm ${mcqCount} câu trắc nghiệm (A-E) và ${fillInCount} câu điền đáp án (số/chữ).`;
          answerGrid.appendChild(note);
        }

        for (let i = 1; i <= numQ; i++) {
          const row = document.createElement('div');
          row.className = 'answer-row';

          if (i <= mcqCount) {
            // Câu trắc nghiệm - chọn A-E
            row.innerHTML = `
              <span class="q-num">${i}</span>
              <div class="options">
                ${['A', 'B', 'C', 'D', 'E'].map(opt => `
                  <label class="option-label">
                    <input type="radio" name="q${i}" value="${opt}" />
                    <span>${opt}</span>
                  </label>
                `).join('')}
              </div>
            `;
          } else {
            // Câu điền đáp án - nhập text
            row.innerHTML = `
              <span class="q-num">${i}</span>
              <div class="fill-in-input">
                <input type="text" name="q${i}" placeholder="Nhập đáp án" style="width: 150px; padding: 4px 8px;" />
              </div>
            `;
          }
          answerGrid.appendChild(row);
        }
      }

      // Answer input tabs
      document.querySelectorAll('.answer-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.answer-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const mode = tab.dataset.mode;
          document.getElementById('manualAnswerInput').hidden = mode !== 'manual';
          document.getElementById('excelAnswerInput').hidden = mode !== 'excel';
        });
      });

      // Sheet file count
      sheetImages.addEventListener('change', () => {
        sheetCount.textContent = `${sheetImages.files.length} file đã chọn`;
      });

      // Excel answer file status
      document.getElementById('answerExcelFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        document.getElementById('answerFileStatus').textContent = file ? file.name : '';
      });

      // Get answers from grid
      function getAnswersFromGrid() {
        const template = gradingTemplate.value;
        const info = templateInfo[template] || { questions: 30 };
        const numQ = info.questions || 30;
        const mcqCount = info.mcq || numQ;

        const answers = [];
        for (let i = 1; i <= numQ; i++) {
          if (i <= mcqCount) {
            // Câu trắc nghiệm - lấy radio được chọn
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            answers.push(selected ? selected.value : '');
          } else {
            // Câu điền đáp án - lấy giá trị text
            const textInput = document.querySelector(`input[name="q${i}"][type="text"]`);
            answers.push(textInput ? textInput.value.trim() : '');
          }
        }
        return answers;
      }

      // Grade button click
      gradeBtn.addEventListener('click', async () => {
        if (!sheetImages.files.length) {
          gradingStatus.textContent = 'Vui lòng chọn ảnh phiếu trả lời!';
          return;
        }

        const template = gradingTemplate.value;
        const isAutoMode = template === 'AUTO';
        const numQ = isAutoMode ? 0 : (templateInfo[template]?.questions || 30);

        // Get answers
        const activeTab = document.querySelector('.answer-tab.active');
        const answerFile = document.getElementById('answerExcelFile').files[0];
        let answers = [];

        if (activeTab?.dataset.mode === 'excel' && answerFile) {
          // Will send file to server
        } else if (isAutoMode) {
          // In auto mode, answer file is required
          if (!answerFile) {
            gradingStatus.textContent = 'Chế độ tự động yêu cầu upload file đáp án (Excel/PDF)!';
            return;
          }
        } else {
          answers = getAnswersFromGrid();
          const filledCount = answers.filter(a => a).length;
          if (filledCount < numQ) {
            if (!confirm(`Chỉ có ${filledCount}/${numQ} đáp án được chọn. Tiếp tục chấm?`)) {
              return;
            }
          }
        }

        gradingStatus.textContent = 'Đang chấm bài...';
        gradeBtn.disabled = true;

        try {
          const formData = new FormData();
          formData.append('template_type', template);

          // Add answer key
          if (activeTab?.dataset.mode === 'excel' && answerFile) {
            formData.append('answer_file', answerFile);
          } else {
            formData.append('answer_key', JSON.stringify(answers));
          }

          // Add sheet images
          for (const file of sheetImages.files) {
            formData.append('files', file);
          }

          const res = await fetch('/api/grade-sheets', { method: 'POST', body: formData });
          const data = await res.json();

          if (data.ok) {
            gradingResults = data.results || [];
            renderGradingResults(data);
            gradingStatus.textContent = `Đã chấm xong ${data.summary?.graded || 0} bài`;
          } else {
            gradingStatus.textContent = 'Lỗi: ' + (data.detail || data.error || 'Không xác định');
          }
        } catch (err) {
          gradingStatus.textContent = 'Lỗi: ' + err.message;
        } finally {
          gradeBtn.disabled = false;
        }
      });

      // Render grading results
      function renderGradingResults(data) {
        gradingResult.hidden = false;
        const summary = data.summary || {};

        gradingSummary.innerHTML = `
          <div class="summary-cards">
            <div class="summary-card">
              <span class="label">Tổng số bài</span>
              <span class="value">${summary.total_sheets || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Đã chấm</span>
              <span class="value">${summary.graded || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Điểm TB</span>
              <span class="value">${summary.average_score || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Cao nhất</span>
              <span class="value">${summary.highest || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Thấp nhất</span>
              <span class="value">${summary.lowest || 0}</span>
            </div>
          </div>
        `;

        const tbody = gradingTable.querySelector('tbody');
        tbody.innerHTML = (data.results || []).map((r, idx) => {
          const info = r.student_info || {};
          if (r.error) {
            return `<tr class="error-row">
              <td>${idx + 1}</td>
              <td>${r.filename || ''}</td>
              <td colspan="8" style="color: var(--danger);">Lỗi: ${r.error}</td>
            </tr>`;
          }
          return `<tr>
            <td>${idx + 1}</td>
            <td>${info.full_name || '-'}</td>
            <td>${info.class || '-'}</td>
            <td>${info.id_no || '-'}</td>
            <td>${info.school_name || '-'}</td>
            <td><strong>${r.score}</strong></td>
            <td style="color: var(--success);">${r.correct}</td>
            <td style="color: var(--danger);">${r.wrong}</td>
            <td>${r.blank}</td>
            <td><button class="view-detail-btn" data-index="${idx}">Xem</button></td>
          </tr>`;
        }).join('');

        // Detail button handlers
        tbody.querySelectorAll('.view-detail-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index);
            showGradingDetail(gradingResults[idx]);
          });
        });
      }

      // Show grading detail modal
      function showGradingDetail(result) {
        if (!result || !result.details) return;
        const modal = document.getElementById('historyModal');
        const title = document.getElementById('modalTitle');
        const body = document.getElementById('modalBody');
        const footer = document.querySelector('.modal-footer');
        footer.hidden = true;

        title.textContent = `Chi tiết: ${result.filename} - Điểm: ${result.score}`;
        body.innerHTML = `
          <div class="detail-summary">
            <span>Đúng: <strong style="color: var(--success);">${result.correct}</strong></span>
            <span>Sai: <strong style="color: var(--danger);">${result.wrong}</strong></span>
            <span>Bỏ trống: <strong>${result.blank}</strong></span>
          </div>
          <table class="detail-table">
            <thead>
              <tr><th>Câu</th><th>Trả lời</th><th>Đáp án</th><th>Kết quả</th></tr>
            </thead>
            <tbody>
              ${result.details.map(d => `
                <tr class="${d.status}">
                  <td>${d.q}</td>
                  <td>${d.student || '-'}</td>
                  <td>${d.correct || '-'}</td>
                  <td>${d.status === 'correct' ? '✓' : d.status === 'blank' ? '-' : '✗'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        modal.hidden = false;
      }

      // Export grading to Excel
      document.getElementById('exportGradingExcel').addEventListener('click', async () => {
        if (!gradingResults.length) {
          alert('Không có kết quả để xuất!');
          return;
        }

        try {
          const formData = new FormData();
          formData.append('results', JSON.stringify(gradingResults));
          formData.append('template_type', gradingTemplate.value);

          const res = await fetch('/api/grade-sheets/export', { method: 'POST', body: formData });
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ket_qua_cham_bai_${gradingTemplate.value}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert('Lỗi xuất Excel: ' + err.message);
        }
      });

      /* ---- Handwritten Grading (Chấm bài viết tay) ---- */
      const hwNumQuestions = document.getElementById('hwNumQuestions');
      const hwValidAnswers = document.getElementById('hwValidAnswers');
      const hwScoringCorrect = document.getElementById('hwScoringCorrect');
      const hwScoringWrong = document.getElementById('hwScoringWrong');
      const hwScoringBlank = document.getElementById('hwScoringBlank');
      const hwAnswerGrid = document.getElementById('hwAnswerGrid');
      const hwAnswerText = document.getElementById('hwAnswerText');
      const hwSheetImages = document.getElementById('hwSheetImages');
      const hwSheetCount = document.getElementById('hwSheetCount');
      const hwGradeBtn = document.getElementById('hwGradeBtn');
      const hwGradingStatus = document.getElementById('hwGradingStatus');
      const hwGradingResult = document.getElementById('hwGradingResult');
      const hwGradingSummary = document.getElementById('hwGradingSummary');
      const hwGradingTable = document.getElementById('hwGradingTable');

      let hwGradingResults = [];

      // Build answer grid for handwritten
      function buildHwAnswerGrid() {
        const numQ = parseInt(hwNumQuestions.value) || 30;
        const validAns = hwValidAnswers.value.split(',').map(a => a.trim().toUpperCase());

        let html = '';
        for (let i = 1; i <= numQ; i++) {
          html += `<div class="answer-item">
            <span class="q-num">${i}</span>
            <div class="options">
              ${validAns.map(opt => `
                <label><input type="radio" name="hwq${i}" value="${opt}" />${opt}</label>
              `).join('')}
            </div>
          </div>`;
        }
        hwAnswerGrid.innerHTML = html;
      }

      // Initialize grid
      buildHwAnswerGrid();

      // Rebuild grid when num questions or valid answers change
      hwNumQuestions.addEventListener('change', buildHwAnswerGrid);
      hwValidAnswers.addEventListener('change', buildHwAnswerGrid);

      // Tab switching for handwritten
      document.querySelectorAll('.hw-answer-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.hw-answer-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const mode = tab.dataset.mode;
          document.getElementById('hwManualAnswerInput').hidden = mode !== 'manual';
          document.getElementById('hwTextAnswerInput').hidden = mode !== 'text';
        });
      });

      // File count display
      hwSheetImages.addEventListener('change', () => {
        hwSheetCount.textContent = `${hwSheetImages.files.length} file đã chọn`;
      });

      // Get answers from handwritten grid
      function getHwAnswersFromGrid() {
        const numQ = parseInt(hwNumQuestions.value) || 30;
        const answers = [];
        for (let i = 1; i <= numQ; i++) {
          const selected = document.querySelector(`input[name="hwq${i}"]:checked`);
          answers.push(selected ? selected.value : '');
        }
        return answers;
      }

      // Grade handwritten button click
      hwGradeBtn.addEventListener('click', async () => {
        if (!hwSheetImages.files.length) {
          hwGradingStatus.textContent = 'Vui lòng chọn ảnh phiếu trả lời!';
          return;
        }

        const numQ = parseInt(hwNumQuestions.value) || 30;

        // Get answers
        const activeTab = document.querySelector('.hw-answer-tab.active');
        let answers = [];

        if (activeTab?.dataset.mode === 'text') {
          // Parse from text
          answers = hwAnswerText.value.split(',').map(a => a.trim().toUpperCase());
        } else {
          answers = getHwAnswersFromGrid();
        }

        const filledCount = answers.filter(a => a).length;
        if (filledCount < numQ) {
          if (!confirm(`Chỉ có ${filledCount}/${numQ} đáp án được chọn. Tiếp tục chấm?`)) {
            return;
          }
        }

        hwGradingStatus.textContent = 'Đang chấm bài... (Lần đầu tiên có thể mất vài phút để tải model OCR)';
        hwGradeBtn.disabled = true;

        try {
          const formData = new FormData();
          formData.append('answer_key', JSON.stringify(answers));
          formData.append('num_questions', numQ);
          formData.append('valid_answers', hwValidAnswers.value);
          formData.append('scoring_correct', hwScoringCorrect.value);
          formData.append('scoring_wrong', hwScoringWrong.value);
          formData.append('scoring_blank', hwScoringBlank.value);

          // Add sheet images
          for (const file of hwSheetImages.files) {
            formData.append('files', file);
          }

          const res = await fetch('/api/grade-handwritten', { method: 'POST', body: formData });
          const data = await res.json();

          if (data.ok) {
            hwGradingResults = data.results || [];
            renderHwGradingResults(data);
            hwGradingStatus.textContent = `Đã chấm xong ${data.summary?.successful || 0} bài`;
          } else {
            hwGradingStatus.textContent = 'Lỗi: ' + (data.detail || data.error || 'Không xác định');
          }
        } catch (err) {
          hwGradingStatus.textContent = 'Lỗi: ' + err.message;
        } finally {
          hwGradeBtn.disabled = false;
        }
      });

      // Render handwritten grading results
      function renderHwGradingResults(data) {
        hwGradingResult.hidden = false;
        const summary = data.summary || {};

        hwGradingSummary.innerHTML = `
          <div class="summary-cards">
            <div class="summary-card">
              <span class="label">Tổng số bài</span>
              <span class="value">${summary.total_sheets || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Thành công</span>
              <span class="value">${summary.successful || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Điểm TB</span>
              <span class="value">${summary.average_score || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Cao nhất</span>
              <span class="value">${summary.highest || 0}</span>
            </div>
            <div class="summary-card">
              <span class="label">Thấp nhất</span>
              <span class="value">${summary.lowest || 0}</span>
            </div>
          </div>
        `;

        const tbody = hwGradingTable.querySelector('tbody');
        tbody.innerHTML = (data.results || []).map((r, idx) => {
          if (r.error) {
            return `<tr class="error-row">
              <td>${idx + 1}</td>
              <td>${r.filename || ''}</td>
              <td colspan="5" style="color: var(--danger);">Lỗi: ${r.error}</td>
            </tr>`;
          }
          return `<tr>
            <td>${idx + 1}</td>
            <td>${r.filename || '-'}</td>
            <td><strong>${r.score}</strong></td>
            <td style="color: var(--success);">${r.correct}</td>
            <td style="color: var(--danger);">${r.wrong}</td>
            <td>${r.blank}</td>
            <td><button class="hw-view-detail-btn" data-index="${idx}">Xem</button></td>
          </tr>`;
        }).join('');

        // Detail button handlers
        tbody.querySelectorAll('.hw-view-detail-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index);
            showHwGradingDetail(hwGradingResults[idx]);
          });
        });
      }

      // Show handwritten grading detail modal
      function showHwGradingDetail(result) {
        if (!result || !result.details) return;
        const modal = document.getElementById('historyModal');
        const title = document.getElementById('modalTitle');
        const body = document.getElementById('modalBody');
        const footer = document.querySelector('.modal-footer');
        footer.hidden = true;

        title.textContent = `Chi tiết: ${result.filename} - Điểm: ${result.score}`;
        body.innerHTML = `
          <div class="detail-summary">
            <span>Đúng: <strong style="color: var(--success);">${result.correct}</strong></span>
            <span>Sai: <strong style="color: var(--danger);">${result.wrong}</strong></span>
            <span>Bỏ trống: <strong>${result.blank}</strong></span>
          </div>
          <table class="detail-table">
            <thead>
              <tr><th>Câu</th><th>Trả lời</th><th>Đáp án</th><th>Độ tin cậy</th><th>Kết quả</th></tr>
            </thead>
            <tbody>
              ${result.details.map(d => `
                <tr class="${d.status} ${d.confidence < 0.5 ? 'low-confidence' : ''}">
                  <td>${d.q}</td>
                  <td>${d.student || '-'}</td>
                  <td>${d.correct || '-'}</td>
                  <td>${d.confidence ? (d.confidence * 100).toFixed(0) + '%' : '-'}</td>
                  <td>${d.status === 'correct' ? '✓' : d.status === 'blank' || d.status === 'not_found' ? '-' : '✗'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <p style="margin-top: 1rem; color: var(--muted); font-size: 0.9rem;">
            <em>* Các ô có độ tin cậy thấp (&lt;50%) được đánh dấu màu vàng và có thể cần kiểm tra lại.</em>
          </p>
        `;
        modal.hidden = false;
      }

      // Export handwritten grading to Excel
      document.getElementById('hwExportExcel').addEventListener('click', async () => {
        if (!hwGradingResults.length) {
          alert('Không có kết quả để xuất!');
          return;
        }

        try {
          const formData = new FormData();
          formData.append('results', JSON.stringify(hwGradingResults));
          formData.append('num_questions', hwNumQuestions.value);

          const res = await fetch('/api/grade-handwritten/export', { method: 'POST', body: formData });
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ket_qua_cham_viet_tay.xlsx';
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert('Lỗi xuất Excel: ' + err.message);
        }
      });

      /* ---- Init ---- */
      loadSampleFolders();
      loadSubjects();
      loadBuildInfo();
      loadEngines();
      loadSettings();
      loadBankStats();
      loadBankQuestions();
      // Load history from server then render
      loadHistoryFromServer().then(() => renderHistory());
    </script>
  </body>
</html>
