<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tạo đề online</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <main class="shell">
      <header class="hero">
        <div>
          <h1>Tạo câu hỏi tự động</h1>
          <p>Tạo câu hỏi tương tự từ mẫu, hoặc sinh câu hỏi theo chủ đề.</p>
        </div>
      </header>

      <section class="panel">
        <form id="gen-form">
          <div class="grid">
            <div class="field">
              <label for="samples">Câu hỏi mẫu (mỗi dòng một câu)</label>
              <div class="sample-loader">
                <select id="sampleSubject"></select>
                <select id="sampleFile"></select>
                <button type="button" id="loadSample">Nạp từ thư mục đề mẫu</button>
              </div>
              <div class="upload-box">
                <input id="uploadSubject" type="text" placeholder="Tên môn (vd: Toan, Vat_ly)" />
                <input id="uploadFile" type="file" accept=".txt,.docx,.md" />
                <button type="button" id="uploadSample">Tải file mẫu lên</button>
                <small id="uploadStatus"></small>
              </div>
              <textarea id="samples" rows="7" placeholder="Ví dụ: Một hình chữ nhật có chiều dài 12cm và rộng 8cm. Tính diện tích?\nBài 2: ..."></textarea>
              <div class="template-box">
                <div class="template-header">
                  <strong>Mẫu gợi ý theo chủ đề</strong>
                  <button type="button" id="insertTemplates">Chèn mẫu</button>
                </div>
                <div id="templateList" class="template-list"></div>
                <small>Nhấn “Chèn mẫu” để thêm các câu mẫu đã chọn vào ô bên trên.</small>
              </div>
            </div>
            <div class="field">
              <label for="topic">Chủ đề</label>
              <select id="topic"></select>
              <small>Danh sách có sẵn + bạn có thể nhập thêm từ khóa.</small>
              <label for="customKeywords" class="mt">Từ khóa tự nhập (ngăn cách bởi dấu phẩy)</label>
              <input id="customKeywords" type="text" placeholder="vd: chu vi, hình tròn, ..." />
              <label class="mt">Biến thể cần tạo</label>
              <input id="variants" type="number" min="1" max="10" value="2" />
              <div class="checks">
                <label><input type="checkbox" id="paraphrase" checked /> Paraphrase</label>
                <label><input type="checkbox" id="numbers" checked /> Thay số liệu</label>
                <label><input type="checkbox" id="context" checked /> Đổi ngữ cảnh</label>
                <label><input type="checkbox" id="useAI" /> Dùng AI (OpenAI)</label>
              </div>
              <button type="submit">Tạo câu hỏi</button>
            </div>
          </div>
        </form>
      </section>

      <section class="panel">
        <h2>Tự tạo từ thư mục đề mẫu</h2>
        <div class="auto-grid">
          <div>
            <label for="autoSubject">Môn (lấy câu từ thư mục đề mẫu)</label>
            <select id="autoSubject"></select>
          </div>
          <div>
            <label for="autoCount">Số câu cần tạo</label>
            <input id="autoCount" type="number" min="1" max="200" value="20" />
          </div>
          <div>
            <label for="autoRatio">Tỉ lệ AI (%)</label>
            <input id="autoRatio" type="number" min="0" max="100" value="30" />
          </div>
          <button id="autoGenerate" type="button">Tự tạo đề</button>
        </div>
        <small>Hệ thống sẽ lấy câu hỏi mẫu theo môn → tạo bộ câu hỏi mới theo số lượng và tỉ lệ AI.</small>
      </section>

      <section class="panel">
        <div class="output-header">
          <h2>Kết quả</h2>
          <div class="actions">
            <button data-export="txt">Xuất TXT</button>
            <button data-export="csv">Xuất CSV</button>
            <button data-export="docx">Xuất DOCX</button>
            <button data-export="pdf">Xuất PDF</button>
          </div>
        </div>
        <ol id="output"></ol>
      </section>
    </main>

    <script>
      const topicSelect = document.getElementById('topic');
      const output = document.getElementById('output');
      const form = document.getElementById('gen-form');
      const templateList = document.getElementById('templateList');
      const sampleSubject = document.getElementById('sampleSubject');
      const sampleFile = document.getElementById('sampleFile');
      const uploadSubject = document.getElementById('uploadSubject');
      const uploadFile = document.getElementById('uploadFile');
      const uploadStatus = document.getElementById('uploadStatus');
      const autoSubject = document.getElementById('autoSubject');

      let templatesByTopic = {};
      let currentQuestions = [];

      async function loadTopics() {
        const [topicsRes, templatesRes] = await Promise.all([
          fetch('/topics'),
          fetch('/templates'),
        ]);
        const data = await topicsRes.json();
        const templates = await templatesRes.json();
        topicSelect.innerHTML = data.topics
          .map((t) => `<option value="${t.key}">${t.label}</option>`)
          .join('');
        templatesByTopic = (templates.templates || []).reduce((acc, item) => {
          acc[item.key] = item.items || [];
          return acc;
        }, {});
        renderTemplates();
      }

      async function loadSampleFolders() {
        const res = await fetch('/sample-folders');
        const data = await res.json();
        const folders = data.folders || [];
        if (!folders.length) {
          sampleSubject.innerHTML = '<option value=\"\">Không có thư mục mẫu</option>';
          sampleFile.innerHTML = '';
          return;
        }
        sampleSubject.innerHTML = folders.map((f) => `<option value="${f}">${f}</option>`).join('');
        await loadSampleFiles();
      }

      async function loadSampleFiles() {
        if (!sampleSubject.value) {
          sampleFile.innerHTML = '';
          return;
        }
        const res = await fetch(`/sample-files?subject=${encodeURIComponent(sampleSubject.value)}`);
        const data = await res.json();
        const files = data.files || [];
        sampleFile.innerHTML = files
          .map((f) => `<option value="${f}">${f}</option>`)
          .join('');
      }

      function renderTemplates() {
        const topic = topicSelect.value;
        const items = templatesByTopic[topic] || [];
        templateList.innerHTML = items
          .map((tpl, idx) => {
            return `
              <label class="template-item">
                <input type="checkbox" value="${idx}" />
                <span>${tpl}</span>
              </label>`;
          })
          .join('');
      }

      function readPayload() {
        const samples = document.getElementById('samples').value
          .split('\n')
          .map((s) => s.trim())
          .filter(Boolean);
        return {
          samples,
          topic: topicSelect.value,
          custom_keywords: document.getElementById('customKeywords').value
            .split(',')
            .map((s) => s.trim())
            .filter(Boolean),
          paraphrase: document.getElementById('paraphrase').checked,
          change_numbers: document.getElementById('numbers').checked,
          change_context: document.getElementById('context').checked,
          variants_per_question: Number(document.getElementById('variants').value) || 1,
          use_ai: document.getElementById('useAI').checked,
        };
      }

      function renderQuestions(questions) {
        currentQuestions = questions;
        output.innerHTML = questions.map((q) => `<li>${q}</li>`).join('');
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = readPayload();
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        renderQuestions(data.questions || []);
      });

      document.querySelectorAll('[data-export]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const formData = new FormData();
          if (currentQuestions.length) {
            formData.append('samples', currentQuestions.join('\n'));
            formData.append('topic', topicSelect.value);
            formData.append('custom_keywords', document.getElementById('customKeywords').value);
            formData.append('paraphrase', false);
            formData.append('change_numbers', false);
            formData.append('change_context', false);
            formData.append('variants_per_question', 1);
            formData.append('use_ai', false);
          } else {
            const payload = readPayload();
            formData.append('samples', payload.samples.join('\n'));
            formData.append('topic', payload.topic);
            formData.append('custom_keywords', payload.custom_keywords.join(','));
            formData.append('paraphrase', payload.paraphrase);
            formData.append('change_numbers', payload.change_numbers);
            formData.append('change_context', payload.change_context);
            formData.append('variants_per_question', payload.variants_per_question);
            formData.append('use_ai', payload.use_ai);
          }
          formData.append('fmt', btn.dataset.export);
          const res = await fetch('/export', { method: 'POST', body: formData });
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const ext = btn.dataset.export;
          a.download = `questions.${ext}`;
          a.click();
          URL.revokeObjectURL(url);
        });
      });

      topicSelect.addEventListener('change', renderTemplates);

      document.getElementById('insertTemplates').addEventListener('click', () => {
        const topic = topicSelect.value;
        const items = templatesByTopic[topic] || [];
        const selected = Array.from(templateList.querySelectorAll('input:checked'))
          .map((input) => items[Number(input.value)])
          .filter(Boolean);
        if (!selected.length) return;
        const textarea = document.getElementById('samples');
        const prefix = textarea.value && !textarea.value.endsWith('\n') ? '\n' : '';
        textarea.value = `${textarea.value}${prefix}${selected.join('\n')}`;
        templateList.querySelectorAll('input:checked').forEach((input) => {
          input.checked = false;
        });
      });

      document.getElementById('loadSample').addEventListener('click', async () => {
        if (!sampleSubject.value || !sampleFile.value) return;
        const res = await fetch(
          `/sample-content?subject=${encodeURIComponent(sampleSubject.value)}&filename=${encodeURIComponent(sampleFile.value)}`
        );
        const data = await res.json();
        if (data.content) {
          const textarea = document.getElementById('samples');
          const prefix = textarea.value && !textarea.value.endsWith('\n') ? '\n' : '';
          textarea.value = `${textarea.value}${prefix}${data.content}`;
        }
      });

      document.getElementById('uploadSample').addEventListener('click', async () => {
        uploadStatus.textContent = '';
        if (!uploadSubject.value.trim()) {
          uploadStatus.textContent = 'Vui lòng nhập tên môn.';
          return;
        }
        if (!uploadFile.files.length) {
          uploadStatus.textContent = 'Vui lòng chọn file.';
          return;
        }
        const formData = new FormData();
        formData.append('subject', uploadSubject.value.trim());
        formData.append('file', uploadFile.files[0]);
        const res = await fetch('/upload-sample', { method: 'POST', body: formData });
        const data = await res.json();
        uploadStatus.textContent = data.message || 'Đã tải lên';
        await loadSampleFolders();
        sampleSubject.value = uploadSubject.value.trim();
        await loadSampleFiles();
        autoSubject.value = uploadSubject.value.trim();
      });

      document.getElementById('autoGenerate').addEventListener('click', async () => {
        if (!autoSubject.value) return;
        const formData = new FormData();
        formData.append('subject', autoSubject.value);
        formData.append('count', document.getElementById('autoCount').value || 20);
        formData.append('ai_ratio', document.getElementById('autoRatio').value || 30);
        formData.append('topic', topicSelect.value);
        formData.append('custom_keywords', document.getElementById('customKeywords').value);
        formData.append('paraphrase', document.getElementById('paraphrase').checked);
        formData.append('change_numbers', document.getElementById('numbers').checked);
        formData.append('change_context', document.getElementById('context').checked);
        formData.append('use_ai', document.getElementById('useAI').checked);
        const res = await fetch('/auto-generate', { method: 'POST', body: formData });
        const data = await res.json();
        renderQuestions(data.questions || []);
      });

      loadTopics();
      loadSampleFolders().then(() => {
        autoSubject.innerHTML = sampleSubject.innerHTML;
      });
      sampleSubject.addEventListener('change', loadSampleFiles);
    </script>
  </body>
</html>
