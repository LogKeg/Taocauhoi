<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tạo đề online</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="hero">
      <div>
        <h1>Tạo câu hỏi tự động</h1>
        <p>Tạo câu hỏi tương tự từ mẫu, hoặc sinh câu hỏi theo chủ đề.</p>
        <p class="build" id="buildInfo"></p>
      </div>
    </header>

    <div class="app-layout">
      <nav class="sidebar">
        <button class="nav-item active" data-tab="tab-auto">Tự tạo từ đề mẫu</button>
        <button class="nav-item" data-tab="tab-topic">Tạo theo chủ đề (AI)</button>
        <button class="nav-item" data-tab="tab-result">Kết quả</button>
        <button class="nav-item" data-tab="tab-blob" id="navBlob" hidden>Quản lý Blob</button>
      </nav>

      <main class="content">
        <section class="tab-panel active" id="tab-auto">
          <div class="panel">
            <h2>Tự tạo từ thư mục đề mẫu</h2>
            <div class="auto-grid">
              <div>
                <label for="autoSubject">Môn (lấy câu từ thư mục đề mẫu)</label>
                <select id="autoSubject"></select>
              </div>
              <div>
                <label for="autoCount">Số câu cần tạo</label>
                <input id="autoCount" type="number" min="1" max="200" value="20" />
              </div>
              <div>
                <label for="autoRatio">Tỉ lệ AI (%)</label>
                <input id="autoRatio" type="number" min="0" max="100" value="30" />
              </div>
              <button id="autoGenerate" type="button">Tự tạo đề</button>
            </div>
            <small>Hệ thống sẽ lấy câu hỏi mẫu theo môn → tạo bộ câu hỏi mới theo số lượng và tỉ lệ AI.</small>
          </div>
        </section>

        <section class="tab-panel" id="tab-topic">
          <div class="panel">
            <h2>Tạo theo chủ đề (AI)</h2>
            <div class="auto-grid">
              <div>
                <label for="topicSubject">Môn học</label>
                <select id="topicSubject"></select>
              </div>
              <div>
                <label for="topicGrade">Lớp</label>
                <select id="topicGrade"></select>
              </div>
              <div>
                <label for="topicType">Dạng câu hỏi</label>
                <select id="topicType"></select>
              </div>
              <div>
                <label for="topicCount">Số câu</label>
                <input id="topicCount" type="number" min="1" max="50" value="10" />
              </div>
              <div>
                <label for="topicEngine">AI Engine</label>
                <select id="topicEngine"></select>
              </div>
              <button id="topicGenerate" type="button">Tạo theo chủ đề</button>
            </div>
            <small>AI sẽ tự tạo câu hỏi theo môn, lớp và dạng câu hỏi bạn chọn.</small>
          </div>
        </section>

        <section class="tab-panel" id="tab-result">
          <div class="panel">
            <div class="output-header">
              <h2>Kết quả</h2>
              <div class="actions">
                <button data-export="txt">Xuất TXT</button>
                <button data-export="csv">Xuất CSV</button>
                <button data-export="docx">Xuất DOCX</button>
                <button data-export="pdf">Xuất PDF</button>
              </div>
            </div>
            <div id="genStatus" class="gen-status"></div>
            <ul id="output" class="output-list"></ul>
          </div>
        </section>

        <section class="tab-panel" id="tab-blob">
          <div class="panel" id="blobManager" hidden>
            <div class="output-header">
              <h2>Quản lý đề mẫu (Blob)</h2>
              <div class="actions">
                <button id="refreshBlob">Làm mới</button>
                <button id="exportBlobCsv">Xuất CSV</button>
              </div>
            </div>
            <div class="blob-meta">
              <span id="blobCount">0 file</span>
              <span id="blobSize">0 KB</span>
            </div>
            <div class="blob-list" id="blobList"></div>
          </div>
        </section>
      </main>
    </div>

    <script type="module">
      import { upload } from 'https://esm.sh/@vercel/blob/client';

      /* ---- Tab switching ---- */
      const navItems = document.querySelectorAll('.nav-item');
      const tabPanels = document.querySelectorAll('.tab-panel');
      const navBlob = document.getElementById('navBlob');

      function switchTab(tabId) {
        navItems.forEach((btn) => btn.classList.toggle('active', btn.dataset.tab === tabId));
        tabPanels.forEach((p) => p.classList.toggle('active', p.id === tabId));
      }
      navItems.forEach((btn) => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      const output = document.getElementById('output');
      const autoSubject = document.getElementById('autoSubject');
      const blobManager = document.getElementById('blobManager');
      const blobList = document.getElementById('blobList');
      const blobCount = document.getElementById('blobCount');
      const blobSize = document.getElementById('blobSize');
      const genStatus = document.getElementById('genStatus');
      const buildInfo = document.getElementById('buildInfo');
      const topicSubject = document.getElementById('topicSubject');
      const topicGrade = document.getElementById('topicGrade');
      const topicType = document.getElementById('topicType');
      const topicEngine = document.getElementById('topicEngine');

      let currentQuestions = [];
      let useBlob = false;
      let blobIndex = {};

      async function loadSubjects() {
        const res = await fetch('/subjects');
        const data = await res.json();
        topicSubject.innerHTML = (data.subjects || [])
          .map((s) => `<option value="${s.key}">${s.label}</option>`)
          .join('');
        topicType.innerHTML = (data.question_types || [])
          .map((t) => `<option value="${t.key}">${t.label}</option>`)
          .join('');
        topicGrade.innerHTML = (data.grades || [])
          .map((g) => `<option value="${g}">${g}</option>`)
          .join('');
      }

      async function loadBuildInfo() {
        try {
          const res = await fetch('/version');
          const data = await res.json();
          if (data.commit) {
            buildInfo.textContent = `Build: ${data.commit.slice(0, 7)}`;
          }
        } catch (err) {
          buildInfo.textContent = '';
        }
      }

      async function loadEngines() {
        const res = await fetch('/ai-engines');
        const data = await res.json();
        const engines = data.engines || [];
        const html = engines
          .map((e) => {
            const disabled = e.available ? '' : ' disabled';
            const suffix = e.available ? '' : ' (N/A)';
            return `<option value="${e.key}"${disabled}>${e.label}${suffix}</option>`;
          })
          .join('');
        topicEngine.innerHTML = html;
        const first = engines.find((e) => e.available);
        if (first) {
          topicEngine.value = first.key;
        }
      }

      async function fetchBlobList(prefix = '') {
        const url = prefix ? `/api/blob/list?prefix=${encodeURIComponent(prefix)}` : '/api/blob/list';
        const res = await fetch(url);
        if (!res.ok) return [];
        const data = await res.json();
        return data.blobs || [];
      }

      async function loadBlobIndex() {
        const blobs = await fetchBlobList();
        const grouped = {};
        blobs.forEach((item) => {
          const pathname = item.pathname || '';
          const parts = pathname.split('/');
          if (parts.length < 2) return;
          const subject = parts[0];
          const file = parts.slice(1).join('/');
          if (!grouped[subject]) grouped[subject] = [];
          grouped[subject].push({ ...item, file });
        });
        blobIndex = grouped;
        const folders = Object.keys(blobIndex).sort();
        if (!folders.length) {
          autoSubject.innerHTML = '<option value="">Không có thư mục mẫu</option>';
          return;
        }
        autoSubject.innerHTML = folders.map((f) => `<option value="${f}">${f}</option>`).join('');
        renderBlobManager(blobs);
      }

      async function loadSampleFolders() {
        const res = await fetch('/sample-folders');
        const data = await res.json();
        const folders = data.folders || [];
        if (!folders.length) {
          useBlob = true;
          await loadBlobIndex();
          blobManager.hidden = false;
          navBlob.hidden = false;
          return;
        }
        useBlob = false;
        blobManager.hidden = true;
        navBlob.hidden = true;
        autoSubject.innerHTML = folders.map((f) => `<option value="${f}">${f}</option>`).join('');
      }

      function renderQuestions(questions) {
        currentQuestions = questions;
        output.innerHTML = questions
          .map((q) => `<li>${q.replace(/\n/g, '<br>')}</li>`)
          .join('');
        if (questions.length) switchTab('tab-result');
      }

      document.querySelectorAll('[data-export]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          if (!currentQuestions.length) return;
          const formData = new FormData();
          formData.append('samples', currentQuestions.join('\n'));
          formData.append('topic', 'toan_hoc');
          formData.append('custom_keywords', '');
          formData.append('paraphrase', false);
          formData.append('change_numbers', false);
          formData.append('change_context', false);
          formData.append('variants_per_question', 1);
          formData.append('use_ai', false);
          formData.append('ai_engine', topicEngine.value || 'openai');
          formData.append('fmt', btn.dataset.export);
          const res = await fetch('/export', { method: 'POST', body: formData });
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const ext = btn.dataset.export;
          a.download = `questions.${ext}`;
          a.click();
          URL.revokeObjectURL(url);
        });
      });

      document.getElementById('autoGenerate').addEventListener('click', async () => {
        if (!autoSubject.value) return;
        genStatus.textContent = '';
        const formData = new FormData();
        formData.append('subject', autoSubject.value);
        formData.append('count', document.getElementById('autoCount').value || 20);
        formData.append('ai_ratio', document.getElementById('autoRatio').value || 30);
        formData.append('topic', 'toan_hoc');
        formData.append('custom_keywords', '');
        formData.append('paraphrase', true);
        formData.append('change_numbers', true);
        formData.append('change_context', true);
        formData.append('use_ai', true);
        formData.append('ai_engine', topicEngine.value || 'openai');

        if (useBlob) {
          const items = blobIndex[autoSubject.value] || [];
          const urls = items.map((item) => item.url);
          const parsed = await fetch('/parse-sample-urls', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ urls }),
          });
          const parsedData = await parsed.json();
          formData.append('samples_text', parsedData.content || '');
        }

        const res = await fetch('/auto-generate', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.message) {
          genStatus.textContent = data.message;
        }
        renderQuestions(data.questions || []);
      });

      document.getElementById('topicGenerate').addEventListener('click', async () => {
        genStatus.textContent = '';
        const formData = new FormData();
        formData.append('subject', topicSubject.value);
        formData.append('grade', topicGrade.value);
        formData.append('qtype', topicType.value);
        formData.append('count', document.getElementById('topicCount').value || 10);
        formData.append('ai_engine', topicEngine.value || 'openai');
        const res = await fetch('/generate-topic', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.message) {
          genStatus.textContent = data.message;
        }
        renderQuestions(data.questions || []);
      });

      function humanSize(bytes) {
        if (!bytes) return '0 KB';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let idx = 0;
        while (size >= 1024 && idx < units.length - 1) {
          size /= 1024;
          idx += 1;
        }
        return `${size.toFixed(size < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
      }

      function renderBlobManager(blobs) {
        if (!useBlob) return;
        const total = blobs.reduce((sum, b) => sum + (b.size || 0), 0);
        blobCount.textContent = `${blobs.length} file`;
        blobSize.textContent = humanSize(total);
        blobList.innerHTML = blobs
          .map((item) => {
            return `
              <div class="blob-row">
                <div class="blob-name">${item.pathname}</div>
                <div class="blob-size">${humanSize(item.size || 0)}</div>
                <button data-url="${item.url}" class="blob-del">Xóa</button>
              </div>`;
          })
          .join('');
        blobList.querySelectorAll('.blob-del').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const url = btn.dataset.url;
            await fetch('/api/blob/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url }),
            });
            await loadBlobIndex();
          });
        });
      }

      document.getElementById('refreshBlob').addEventListener('click', async () => {
        if (!useBlob) return;
        await loadBlobIndex();
      });

      document.getElementById('exportBlobCsv').addEventListener('click', async () => {
        if (!useBlob) return;
        const blobs = await fetchBlobList();
        const header = 'pathname,size,url';
        const rows = blobs.map((b) => `${b.pathname},${b.size || 0},${b.url}`);
        const content = [header, ...rows].join('\n');
        const blob = new Blob([content], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'blob_samples.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      loadSampleFolders();
      loadSubjects();
      loadBuildInfo();
      loadEngines();
    </script>
  </body>
</html>
