<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tạo đề online</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <main class="shell">
      <header class="hero">
        <div>
          <h1>Tạo câu hỏi tự động</h1>
          <p>Tạo câu hỏi tương tự từ mẫu, hoặc sinh câu hỏi theo chủ đề.</p>
        </div>
      </header>

      <section class="panel">
        <form id="gen-form">
          <div class="grid">
            <div class="field">
              <label for="samples">Câu hỏi mẫu (mỗi dòng một câu)</label>
              <div class="sample-loader">
                <select id="sampleSubject"></select>
                <select id="sampleFile"></select>
                <button type="button" id="loadSample">Nạp từ thư mục đề mẫu</button>
              </div>
              <div class="upload-box">
                <input id="uploadSubject" type="text" placeholder="Tên môn (vd: Toan, Vat_ly)" />
                <input id="uploadFile" type="file" accept=".txt,.docx,.md" />
                <button type="button" id="uploadSample">Tải file mẫu lên</button>
                <small id="uploadStatus"></small>
              </div>
              <textarea id="samples" rows="7" placeholder="Ví dụ: Một hình chữ nhật có chiều dài 12cm và rộng 8cm. Tính diện tích?\nBài 2: ..."></textarea>
              <div class="template-box">
                <div class="template-header">
                  <strong>Mẫu gợi ý theo chủ đề</strong>
                  <button type="button" id="insertTemplates">Chèn mẫu</button>
                </div>
                <div id="templateList" class="template-list"></div>
                <small>Nhấn “Chèn mẫu” để thêm các câu mẫu đã chọn vào ô bên trên.</small>
              </div>
            </div>
            <div class="field">
              <label for="topic">Chủ đề</label>
              <select id="topic"></select>
              <small>Danh sách có sẵn + bạn có thể nhập thêm từ khóa.</small>
              <label for="customKeywords" class="mt">Từ khóa tự nhập (ngăn cách bởi dấu phẩy)</label>
              <input id="customKeywords" type="text" placeholder="vd: chu vi, hình tròn, ..." />
              <label class="mt">Biến thể cần tạo</label>
              <input id="variants" type="number" min="1" max="10" value="2" />
              <div class="checks">
                <label><input type="checkbox" id="paraphrase" checked /> Paraphrase</label>
                <label><input type="checkbox" id="numbers" checked /> Thay số liệu</label>
                <label><input type="checkbox" id="context" checked /> Đổi ngữ cảnh</label>
                <label><input type="checkbox" id="useAI" /> Dùng AI (OpenAI)</label>
              </div>
              <button type="submit">Tạo câu hỏi</button>
            </div>
          </div>
        </form>
      </section>

      <section class="panel">
        <h2>Tự tạo từ thư mục đề mẫu</h2>
        <div class="auto-grid">
          <div>
            <label for="autoSubject">Môn (lấy câu từ thư mục đề mẫu)</label>
            <select id="autoSubject"></select>
          </div>
          <div>
            <label for="autoCount">Số câu cần tạo</label>
            <input id="autoCount" type="number" min="1" max="200" value="20" />
          </div>
          <div>
            <label for="autoRatio">Tỉ lệ AI (%)</label>
            <input id="autoRatio" type="number" min="0" max="100" value="30" />
          </div>
          <button id="autoGenerate" type="button">Tự tạo đề</button>
        </div>
        <small>Hệ thống sẽ lấy câu hỏi mẫu theo môn → tạo bộ câu hỏi mới theo số lượng và tỉ lệ AI.</small>
      </section>

      <section class="panel">
        <div class="output-header">
          <h2>Kết quả</h2>
          <div class="actions">
            <button data-export="txt">Xuất TXT</button>
            <button data-export="csv">Xuất CSV</button>
            <button data-export="docx">Xuất DOCX</button>
            <button data-export="pdf">Xuất PDF</button>
          </div>
        </div>
        <div id="genStatus" class="gen-status"></div>
        <ul id="output" class="output-list"></ul>
      </section>

      <section class="panel" id="blobManager" hidden>
        <div class="output-header">
          <h2>Quản lý đề mẫu (Blob)</h2>
          <div class="actions">
            <button id="refreshBlob">Làm mới</button>
            <button id="exportBlobCsv">Xuất CSV</button>
          </div>
        </div>
        <div class="blob-meta">
          <span id="blobCount">0 file</span>
          <span id="blobSize">0 KB</span>
        </div>
        <div class="blob-list" id="blobList"></div>
      </section>
    </main>

    <script type="module">
      import { upload } from 'https://esm.sh/@vercel/blob/client';

      const topicSelect = document.getElementById('topic');
      const output = document.getElementById('output');
      const form = document.getElementById('gen-form');
      const templateList = document.getElementById('templateList');
      const sampleSubject = document.getElementById('sampleSubject');
      const sampleFile = document.getElementById('sampleFile');
      const uploadSubject = document.getElementById('uploadSubject');
      const uploadFile = document.getElementById('uploadFile');
      const uploadStatus = document.getElementById('uploadStatus');
      const autoSubject = document.getElementById('autoSubject');
      const blobManager = document.getElementById('blobManager');
      const blobList = document.getElementById('blobList');
      const blobCount = document.getElementById('blobCount');
      const blobSize = document.getElementById('blobSize');
      const genStatus = document.getElementById('genStatus');

      let templatesByTopic = {};
      let currentQuestions = [];
      let useBlob = false;
      let blobIndex = {};

      async function loadTopics() {
        const [topicsRes, templatesRes] = await Promise.all([
          fetch('/topics'),
          fetch('/templates'),
        ]);
        const data = await topicsRes.json();
        const templates = await templatesRes.json();
        topicSelect.innerHTML = data.topics
          .map((t) => `<option value="${t.key}">${t.label}</option>`)
          .join('');
        templatesByTopic = (templates.templates || []).reduce((acc, item) => {
          acc[item.key] = item.items || [];
          return acc;
        }, {});
        renderTemplates();
      }

      async function fetchBlobList(prefix = '') {
        const url = prefix ? `/api/blob/list?prefix=${encodeURIComponent(prefix)}` : '/api/blob/list';
        const res = await fetch(url);
        if (!res.ok) return [];
        const data = await res.json();
        return data.blobs || [];
      }

      async function loadBlobIndex() {
        const blobs = await fetchBlobList();
        const grouped = {};
        blobs.forEach((item) => {
          const pathname = item.pathname || '';
          const parts = pathname.split('/');
          if (parts.length < 2) return;
          const subject = parts[0];
          const file = parts.slice(1).join('/');
          if (!grouped[subject]) grouped[subject] = [];
          grouped[subject].push({ ...item, file });
        });
        blobIndex = grouped;
        const folders = Object.keys(blobIndex).sort();
        if (!folders.length) {
          sampleSubject.innerHTML = '<option value="">Không có thư mục mẫu</option>';
          sampleFile.innerHTML = '';
          return;
        }
        sampleSubject.innerHTML = folders.map((f) => `<option value="${f}">${f}</option>`).join('');
        autoSubject.innerHTML = sampleSubject.innerHTML;
        await loadSampleFiles();
        renderBlobManager(blobs);
      }

      async function loadSampleFolders() {
        const res = await fetch('/sample-folders');
        const data = await res.json();
        const folders = data.folders || [];
        if (!folders.length) {
          useBlob = true;
          await loadBlobIndex();
          blobManager.hidden = false;
          return;
        }
        useBlob = false;
        blobManager.hidden = true;
        sampleSubject.innerHTML = folders.map((f) => `<option value="${f}">${f}</option>`).join('');
        autoSubject.innerHTML = sampleSubject.innerHTML;
        await loadSampleFiles();
      }

      async function loadSampleFiles() {
        if (!sampleSubject.value) {
          sampleFile.innerHTML = '';
          return;
        }
        if (useBlob) {
          const files = (blobIndex[sampleSubject.value] || []).map((item) => item.file);
          sampleFile.innerHTML = files.map((f) => `<option value="${f}">${f}</option>`).join('');
          return;
        }
        const res = await fetch(`/sample-files?subject=${encodeURIComponent(sampleSubject.value)}`);
        const data = await res.json();
        const files = data.files || [];
        sampleFile.innerHTML = files.map((f) => `<option value="${f}">${f}</option>`).join('');
      }

      function renderTemplates() {
        const topic = topicSelect.value;
        const items = templatesByTopic[topic] || [];
        templateList.innerHTML = items
          .map((tpl, idx) => {
            return `
              <label class="template-item">
                <input type="checkbox" value="${idx}" />
                <span>${tpl}</span>
              </label>`;
          })
          .join('');
      }

      function readPayload() {
        const samples = document.getElementById('samples').value
          .split('\n')
          .map((s) => s.trim())
          .filter(Boolean);
        return {
          samples,
          topic: topicSelect.value,
          custom_keywords: document.getElementById('customKeywords').value
            .split(',')
            .map((s) => s.trim())
            .filter(Boolean),
          paraphrase: document.getElementById('paraphrase').checked,
          change_numbers: document.getElementById('numbers').checked,
          change_context: document.getElementById('context').checked,
          variants_per_question: Number(document.getElementById('variants').value) || 1,
          use_ai: document.getElementById('useAI').checked,
        };
      }

      function renderQuestions(questions) {
        currentQuestions = questions;
        output.innerHTML = questions
          .map((q) => `<li>${q.replace(/\n/g, '<br>')}</li>`)
          .join('');
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        genStatus.textContent = '';
        const payload = readPayload();
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.message) {
          genStatus.textContent = data.message;
        }
        renderQuestions(data.questions || []);
      });

      document.querySelectorAll('[data-export]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const formData = new FormData();
          if (currentQuestions.length) {
            formData.append('samples', currentQuestions.join('\n'));
            formData.append('topic', topicSelect.value);
            formData.append('custom_keywords', document.getElementById('customKeywords').value);
            formData.append('paraphrase', false);
            formData.append('change_numbers', false);
            formData.append('change_context', false);
            formData.append('variants_per_question', 1);
            formData.append('use_ai', false);
          } else {
            const payload = readPayload();
            formData.append('samples', payload.samples.join('\n'));
            formData.append('topic', payload.topic);
            formData.append('custom_keywords', payload.custom_keywords.join(','));
            formData.append('paraphrase', payload.paraphrase);
            formData.append('change_numbers', payload.change_numbers);
            formData.append('change_context', payload.change_context);
            formData.append('variants_per_question', payload.variants_per_question);
            formData.append('use_ai', payload.use_ai);
          }
          formData.append('fmt', btn.dataset.export);
          const res = await fetch('/export', { method: 'POST', body: formData });
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const ext = btn.dataset.export;
          a.download = `questions.${ext}`;
          a.click();
          URL.revokeObjectURL(url);
        });
      });

      topicSelect.addEventListener('change', renderTemplates);

      document.getElementById('insertTemplates').addEventListener('click', () => {
        const topic = topicSelect.value;
        const items = templatesByTopic[topic] || [];
        const selected = Array.from(templateList.querySelectorAll('input:checked'))
          .map((input) => items[Number(input.value)])
          .filter(Boolean);
        if (!selected.length) return;
        const textarea = document.getElementById('samples');
        const prefix = textarea.value && !textarea.value.endsWith('\n') ? '\n' : '';
        textarea.value = `${textarea.value}${prefix}${selected.join('\n')}`;
        templateList.querySelectorAll('input:checked').forEach((input) => {
          input.checked = false;
        });
      });

      document.getElementById('loadSample').addEventListener('click', async () => {
        if (!sampleSubject.value || !sampleFile.value) return;
        if (useBlob) {
          const items = blobIndex[sampleSubject.value] || [];
          const match = items.find((item) => item.file === sampleFile.value);
          if (!match) return;
          const res = await fetch('/parse-sample-urls', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ urls: [match.url] }),
          });
          const data = await res.json();
          if (data.content) {
            const textarea = document.getElementById('samples');
            const prefix = textarea.value && !textarea.value.endsWith('\n') ? '\n' : '';
            textarea.value = `${textarea.value}${prefix}${data.content}`;
          }
          return;
        }
        const res = await fetch(
          `/sample-content?subject=${encodeURIComponent(sampleSubject.value)}&filename=${encodeURIComponent(sampleFile.value)}`
        );
        const data = await res.json();
        if (data.content) {
          const textarea = document.getElementById('samples');
          const prefix = textarea.value && !textarea.value.endsWith('\n') ? '\n' : '';
          textarea.value = `${textarea.value}${prefix}${data.content}`;
        }
      });

      document.getElementById('uploadSample').addEventListener('click', async () => {
        uploadStatus.textContent = '';
        if (!uploadSubject.value.trim()) {
          uploadStatus.textContent = 'Vui lòng nhập tên môn.';
          return;
        }
        if (!uploadFile.files.length) {
          uploadStatus.textContent = 'Vui lòng chọn file.';
          return;
        }
        if (useBlob) {
          try {
            await upload(uploadFile.files[0].name, uploadFile.files[0], {
              access: 'public',
              handleUploadUrl: '/api/blob/upload',
              pathname: `${uploadSubject.value.trim()}/${uploadFile.files[0].name}`,
            });
            uploadStatus.textContent = 'Đã tải lên Blob';
            await loadBlobIndex();
            sampleSubject.value = uploadSubject.value.trim();
            await loadSampleFiles();
            autoSubject.value = uploadSubject.value.trim();
          } catch (err) {
            uploadStatus.textContent = 'Upload thất bại';
          }
          return;
        }
        const formData = new FormData();
        formData.append('subject', uploadSubject.value.trim());
        formData.append('file', uploadFile.files[0]);
        const res = await fetch('/upload-sample', { method: 'POST', body: formData });
        const data = await res.json();
        uploadStatus.textContent = data.message || 'Đã tải lên';
        await loadSampleFolders();
        sampleSubject.value = uploadSubject.value.trim();
        await loadSampleFiles();
        autoSubject.value = uploadSubject.value.trim();
      });

      document.getElementById('autoGenerate').addEventListener('click', async () => {
        if (!autoSubject.value) return;
        genStatus.textContent = '';
        const formData = new FormData();
        formData.append('subject', autoSubject.value);
        formData.append('count', document.getElementById('autoCount').value || 20);
        formData.append('ai_ratio', document.getElementById('autoRatio').value || 30);
        formData.append('topic', topicSelect.value);
        formData.append('custom_keywords', document.getElementById('customKeywords').value);
        formData.append('paraphrase', document.getElementById('paraphrase').checked);
        formData.append('change_numbers', document.getElementById('numbers').checked);
        formData.append('change_context', document.getElementById('context').checked);
        formData.append('use_ai', document.getElementById('useAI').checked);

        if (useBlob) {
          const items = blobIndex[autoSubject.value] || [];
          const urls = items.map((item) => item.url);
          const parsed = await fetch('/parse-sample-urls', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ urls }),
          });
          const parsedData = await parsed.json();
          formData.append('samples_text', parsedData.content || '');
        }

        const res = await fetch('/auto-generate', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.message) {
          genStatus.textContent = data.message;
        }
        renderQuestions(data.questions || []);
      });

      function humanSize(bytes) {
        if (!bytes) return '0 KB';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let idx = 0;
        while (size >= 1024 && idx < units.length - 1) {
          size /= 1024;
          idx += 1;
        }
        return `${size.toFixed(size < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
      }

      function renderBlobManager(blobs) {
        if (!useBlob) return;
        const total = blobs.reduce((sum, b) => sum + (b.size || 0), 0);
        blobCount.textContent = `${blobs.length} file`;
        blobSize.textContent = humanSize(total);
        blobList.innerHTML = blobs
          .map((item) => {
            return `
              <div class="blob-row">
                <div class="blob-name">${item.pathname}</div>
                <div class="blob-size">${humanSize(item.size || 0)}</div>
                <button data-url="${item.url}" class="blob-del">Xóa</button>
              </div>`;
          })
          .join('');
        blobList.querySelectorAll('.blob-del').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const url = btn.dataset.url;
            await fetch('/api/blob/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url }),
            });
            await loadBlobIndex();
          });
        });
      }

      document.getElementById('refreshBlob').addEventListener('click', async () => {
        if (!useBlob) return;
        await loadBlobIndex();
      });

      document.getElementById('exportBlobCsv').addEventListener('click', async () => {
        if (!useBlob) return;
        const blobs = await fetchBlobList();
        const header = 'pathname,size,url';
        const rows = blobs.map((b) => `${b.pathname},${b.size || 0},${b.url}`);
        const content = [header, ...rows].join('\n');
        const blob = new Blob([content], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'blob_samples.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      loadTopics();
      loadSampleFolders().then(() => {
        autoSubject.innerHTML = sampleSubject.innerHTML;
      });
      sampleSubject.addEventListener('change', loadSampleFiles);
    </script>
  </body>
</html>
