<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tạo đề online</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="hero">
      <div>
        <h1>Tạo câu hỏi tự động</h1>
        <p>Tạo câu hỏi tương tự từ mẫu, hoặc sinh câu hỏi theo chủ đề.</p>
        <p class="build" id="buildInfo"></p>
      </div>
    </header>

    <div class="app-layout">
      <nav class="sidebar">
        <button class="nav-item active" data-tab="tab-create">Tạo đề từ đề mẫu</button>
        <button class="nav-item" data-tab="tab-topic">Tạo theo chủ đề (AI)</button>
        <button class="nav-item" data-tab="tab-convert">Word → Excel</button>
        <button class="nav-item" data-tab="tab-bank">Ngân hàng câu hỏi</button>
        <button class="nav-item" data-tab="tab-history">Lịch sử sử dụng</button>
        <button class="nav-item" data-tab="tab-settings">Cài đặt</button>
        <button class="nav-item" data-tab="tab-blob" id="navBlob" hidden>Quản lý Blob</button>
      </nav>

      <main class="content">
        <!-- Tab: Tạo đề từ đề mẫu -->
        <section class="tab-panel active" id="tab-create">
          <div class="panel">
            <h2>Tạo đề từ đề mẫu</h2>
            <p>Upload file Word (.docx) chứa đề mẫu để tạo đề mới tương tự.</p>
            <div class="upload-area">
              <input type="file" id="createFile" accept=".docx" />
            </div>
            <div class="create-options">
              <div class="auto-grid">
                <div>
                  <label for="createCount">Số câu cần tạo</label>
                  <input id="createCount" type="number" min="1" max="100" value="20" />
                </div>
                <div>
                  <label for="createEngine">AI Engine</label>
                  <select id="createEngine"></select>
                </div>
                <button id="createBtn" type="button">Tạo đề mới</button>
              </div>
            </div>
            <div class="gen-status" id="createStatus"></div>
          </div>
          <div class="panel result-panel" id="createResult" hidden>
            <div class="output-header">
              <h2>Đề mới (<span id="createResultCount">0</span> câu)</h2>
              <div class="actions">
                <button id="createExportDocx">Xuất DOCX</button>
                <button id="createExportPdf">Xuất PDF</button>
                <button id="createSaveHistory">Lưu lịch sử</button>
              </div>
            </div>
            <div class="create-output" id="createOutput"></div>
          </div>
        </section>

        <section class="tab-panel" id="tab-topic">
          <div class="panel">
            <h2>Tạo theo chủ đề (AI)</h2>
            <div class="auto-grid">
              <div>
                <label for="topicSubject">Môn học</label>
                <select id="topicSubject"></select>
              </div>
              <div>
                <label for="topicTopic">Chủ đề</label>
                <select id="topicTopic"><option value="">-- Tất cả --</option></select>
              </div>
              <div>
                <label for="topicGrade">Lớp</label>
                <select id="topicGrade"></select>
              </div>
              <div>
                <label for="topicType">Dạng câu hỏi</label>
                <select id="topicType"></select>
              </div>
              <div>
                <label for="topicCount">Số câu</label>
                <input id="topicCount" type="number" min="1" max="50" value="10" />
              </div>
              <div>
                <label for="topicEngine">AI Engine</label>
                <select id="topicEngine"></select>
              </div>
              <button id="topicGenerate" type="button">Tạo theo chủ đề</button>
            </div>
            <small>AI sẽ tự tạo câu hỏi theo môn, lớp và dạng câu hỏi bạn chọn.</small>
          </div>
          <div class="panel result-panel" id="topicResult" hidden>
            <div class="output-header">
              <h2>Kết quả</h2>
              <div class="actions">
                <button data-export="txt">Xuất TXT</button>
                <button data-export="csv">Xuất CSV</button>
                <button data-export="docx">Xuất DOCX</button>
                <button data-export="pdf">Xuất PDF</button>
              </div>
            </div>
            <div class="gen-status" id="topicStatus"></div>
            <ol class="output-list" id="topicOutput"></ol>
            <div class="answers-section" id="topicAnswers" hidden>
              <button class="toggle-answers" id="toggleAnswers">Hiện đáp án</button>
              <div class="answers-content" id="answersContent" hidden></div>
            </div>
          </div>
        </section>

        <!-- Tab: Word to Excel -->
        <section class="tab-panel" id="tab-convert">
          <div class="panel">
            <h2>Chuyển đổi Word sang Excel</h2>
            <p>Upload file Word (.docx) chứa câu hỏi để xuất ra file Excel.</p>
            <div class="upload-area">
              <input type="file" id="convertFile" accept=".docx" />
              <button id="convertBtn" type="button">Chuyển đổi</button>
            </div>
            <div class="gen-status" id="convertStatus"></div>
          </div>
        </section>

        <!-- Tab: Question Bank -->
        <section class="tab-panel" id="tab-bank">
          <div class="panel">
            <h2>Ngân hàng câu hỏi</h2>
            <div class="bank-filters">
              <select id="bankSubject">
                <option value="">Tất cả môn</option>
              </select>
              <select id="bankDifficulty">
                <option value="">Tất cả độ khó</option>
                <option value="easy">Dễ</option>
                <option value="medium">Trung bình</option>
                <option value="hard">Khó</option>
              </select>
              <input type="text" id="bankSearch" placeholder="Tìm kiếm..." />
              <button id="bankSearchBtn">Tìm</button>
              <button id="bankRefreshBtn">Làm mới</button>
            </div>
            <div class="bank-stats" id="bankStats"></div>
          </div>
          <div class="panel">
            <div class="output-header">
              <h3>Danh sách câu hỏi (<span id="bankTotal">0</span>)</h3>
              <div class="actions">
                <button id="addQuestionBtn">+ Thêm câu hỏi</button>
              </div>
            </div>
            <div class="bank-list" id="bankList"></div>
            <div class="bank-pagination" id="bankPagination"></div>
          </div>
        </section>

        <!-- Tab: Lịch sử sử dụng -->
        <section class="tab-panel" id="tab-history">
          <div class="panel">
            <h2>Lịch sử sử dụng</h2>
            <div class="history-actions">
              <button id="historyRefreshBtn">Làm mới</button>
              <button id="historyClearBtn">Xóa tất cả</button>
            </div>
            <div class="gen-status" id="historyStatus"></div>
          </div>
          <div class="panel">
            <div class="history-list" id="historyList">
              <p>Chưa có lịch sử.</p>
            </div>
          </div>
        </section>

        <section class="tab-panel" id="tab-settings">
          <div class="panel">
            <h2>Cài đặt AI</h2>
            <div class="settings-grid">
              <fieldset class="settings-group">
                <legend>OpenAI</legend>
                <label for="setOpenaiKey">API Key</label>
                <input id="setOpenaiKey" type="password" placeholder="sk-..." autocomplete="off" />
                <label for="setOpenaiModel">Model</label>
                <input id="setOpenaiModel" type="text" placeholder="gpt-4o-mini" />
                <label for="setOpenaiBase">API Base URL</label>
                <input id="setOpenaiBase" type="text" placeholder="https://api.openai.com/v1" />
              </fieldset>
              <fieldset class="settings-group">
                <legend>Google Gemini</legend>
                <label for="setGeminiKey">API Key</label>
                <input id="setGeminiKey" type="password" placeholder="AIza..." autocomplete="off" />
                <label for="setGeminiModel">Model</label>
                <input id="setGeminiModel" type="text" placeholder="gemini-2.0-flash" />
              </fieldset>
              <fieldset class="settings-group">
                <legend>Ollama (local)</legend>
                <label for="setOllamaBase">Base URL</label>
                <input id="setOllamaBase" type="text" placeholder="http://localhost:11434" />
                <label for="setOllamaModel">Model</label>
                <input id="setOllamaModel" type="text" placeholder="llama3.2" />
              </fieldset>
            </div>
            <div class="settings-actions">
              <button id="saveSettings" type="button">Lưu cài đặt</button>
              <span id="settingsStatus" class="gen-status"></span>
            </div>
            <div class="engine-status" id="engineStatus"></div>
          </div>
        </section>

        <section class="tab-panel" id="tab-blob">
          <div class="panel" id="blobManager" hidden>
            <div class="output-header">
              <h2>Quản lý đề mẫu (Blob)</h2>
              <div class="actions">
                <button id="refreshBlob">Làm mới</button>
                <button id="exportBlobCsv">Xuất CSV</button>
              </div>
            </div>
            <div class="blob-meta">
              <span id="blobCount">0 file</span>
              <span id="blobSize">0 KB</span>
            </div>
            <div class="blob-list" id="blobList"></div>
          </div>
        </section>
      </main>
    </div>

    <script type="module">
      import { upload } from 'https://esm.sh/@vercel/blob/client';

      /* ---- Tab switching ---- */
      const navItems = document.querySelectorAll('.nav-item');
      const tabPanels = document.querySelectorAll('.tab-panel');
      const navBlob = document.getElementById('navBlob');

      function switchTab(tabId) {
        navItems.forEach((btn) => btn.classList.toggle('active', btn.dataset.tab === tabId));
        tabPanels.forEach((p) => p.classList.toggle('active', p.id === tabId));
      }
      navItems.forEach((btn) => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      const blobManager = document.getElementById('blobManager');
      const blobList = document.getElementById('blobList');
      const blobCount = document.getElementById('blobCount');
      const blobSize = document.getElementById('blobSize');
      const buildInfo = document.getElementById('buildInfo');
      const topicSubject = document.getElementById('topicSubject');
      const topicGrade = document.getElementById('topicGrade');
      const topicType = document.getElementById('topicType');

      let currentQuestions = [];
      let createdQuestions = [];
      let useBlob = false;
      let blobIndex = {};
      let activeEngine = 'openai';
      let subjectTopics = {};
      let usageHistory = JSON.parse(localStorage.getItem('usageHistory') || '[]');

      async function loadSubjects() {
        const res = await fetch('/subjects');
        const data = await res.json();
        subjectTopics = data.topics || {};
        topicSubject.innerHTML = (data.subjects || [])
          .map((s) => `<option value="${s.key}">${s.label}</option>`)
          .join('');
        topicType.innerHTML = (data.question_types || [])
          .map((t) => `<option value="${t.key}">${t.label}</option>`)
          .join('');
        topicGrade.innerHTML = (data.grades || [])
          .map((g) => `<option value="${g}">${g}</option>`)
          .join('');
        updateTopicTopics();
      }

      function updateTopicTopics() {
        const topics = subjectTopics[topicSubject.value] || [];
        const topicSelect = document.getElementById('topicTopic');
        topicSelect.innerHTML = '<option value="">-- Tất cả --</option>' +
          topics.map((t) => `<option value="${t.key}">${t.label}</option>`).join('');
      }

      topicSubject.addEventListener('change', updateTopicTopics);

      async function loadBuildInfo() {
        try {
          const res = await fetch('/version');
          const data = await res.json();
          if (data.commit) {
            buildInfo.textContent = `Build: ${data.commit.slice(0, 7)}`;
          }
        } catch (err) {
          buildInfo.textContent = '';
        }
      }

      async function loadEngines() {
        const res = await fetch('/ai-engines');
        const data = await res.json();
        const engines = data.engines || [];
        const first = engines.find((e) => e.available);
        if (first) activeEngine = first.key;
        renderEngineStatus(engines);
        renderEngineSelects(engines);
      }

      function renderEngineSelects(engines) {
        const available = engines.filter((e) => e.available);
        const html = available
          .map((e) => `<option value="${e.key}"${e.key === activeEngine ? ' selected' : ''}>${e.label}</option>`)
          .join('');
        document.getElementById('createEngine').innerHTML = html || '<option value="">Không có AI</option>';
        document.getElementById('topicEngine').innerHTML = html || '<option value="">Không có AI</option>';
      }

      function renderEngineStatus(engines) {
        const el = document.getElementById('engineStatus');
        el.innerHTML = '<h3>Trạng thái kết nối</h3>' + engines
          .map((e) => {
            const dot = e.available ? '<span class="dot dot-ok"></span>' : '<span class="dot dot-off"></span>';
            return `<div class="engine-row">${dot} ${e.label}</div>`;
          })
          .join('');
      }

      /* ---- Settings ---- */
      async function loadSettings() {
        const res = await fetch('/ai-settings');
        const s = await res.json();
        document.getElementById('setOpenaiKey').placeholder = s.openai_key || 'sk-...';
        document.getElementById('setOpenaiModel').placeholder = s.openai_model;
        document.getElementById('setOpenaiBase').placeholder = s.openai_base;
        document.getElementById('setGeminiKey').placeholder = s.gemini_key || 'AIza...';
        document.getElementById('setGeminiModel').placeholder = s.gemini_model;
        document.getElementById('setOllamaBase').placeholder = s.ollama_base;
        document.getElementById('setOllamaModel').placeholder = s.ollama_model;
      }

      document.getElementById('saveSettings').addEventListener('click', async () => {
        const status = document.getElementById('settingsStatus');
        status.textContent = 'Đang lưu...';
        const payload = {};
        const fields = [
          ['setOpenaiKey', 'openai_key'],
          ['setOpenaiModel', 'openai_model'],
          ['setOpenaiBase', 'openai_base'],
          ['setGeminiKey', 'gemini_key'],
          ['setGeminiModel', 'gemini_model'],
          ['setOllamaBase', 'ollama_base'],
          ['setOllamaModel', 'ollama_model'],
        ];
        fields.forEach(([id, key]) => {
          const val = document.getElementById(id).value.trim();
          if (val) payload[key] = val;
        });
        await fetch('/ai-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        // Clear inputs after saving
        fields.forEach(([id]) => { document.getElementById(id).value = ''; });
        await loadSettings();
        await loadEngines();
        status.textContent = 'Đã lưu!';
        setTimeout(() => { status.textContent = ''; }, 2000);
      });

      /* ---- Blob ---- */
      async function fetchBlobList(prefix = '') {
        const url = prefix ? `/api/blob/list?prefix=${encodeURIComponent(prefix)}` : '/api/blob/list';
        const res = await fetch(url);
        if (!res.ok) return [];
        const data = await res.json();
        return data.blobs || [];
      }

      async function loadBlobIndex() {
        const blobs = await fetchBlobList();
        blobIndex = {};
        blobs.forEach((item) => {
          const pathname = item.pathname || '';
          const parts = pathname.split('/');
          if (parts.length < 2) return;
          const subject = parts[0];
          const file = parts.slice(1).join('/');
          if (!blobIndex[subject]) blobIndex[subject] = [];
          blobIndex[subject].push({ ...item, file });
        });
        renderBlobManager(blobs);
      }

      async function loadSampleFolders() {
        const res = await fetch('/sample-folders');
        const data = await res.json();
        const folders = data.folders || [];
        if (!folders.length) {
          useBlob = true;
          await loadBlobIndex();
          blobManager.hidden = false;
          navBlob.hidden = false;
          return;
        }
        useBlob = false;
        blobManager.hidden = true;
        navBlob.hidden = true;
      }

      /* ---- Render results inline ---- */
      function renderQuestions(questions, outputEl, statusEl, resultPanel) {
        currentQuestions = questions;
        outputEl.innerHTML = questions
          .map((q, i) => `<li><strong>Câu ${i + 1}.</strong> ${q.replace(/\n/g, '<br>')}</li>`)
          .join('');
        // Always keep panel visible so user can see error messages
        resultPanel.hidden = false;
      }

      /* ---- Export ---- */
      function attachExport(container) {
        container.querySelectorAll('[data-export]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            if (!currentQuestions.length) return;
            const formData = new FormData();
            formData.append('samples', currentQuestions.join('\n'));
            formData.append('topic', 'toan_hoc');
            formData.append('custom_keywords', '');
            formData.append('paraphrase', false);
            formData.append('change_numbers', false);
            formData.append('change_context', false);
            formData.append('variants_per_question', 1);
            formData.append('use_ai', false);
            formData.append('ai_engine', activeEngine);
            formData.append('fmt', btn.dataset.export);
            const res = await fetch('/export', { method: 'POST', body: formData });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `questions.${btn.dataset.export}`;
            a.click();
            URL.revokeObjectURL(url);
          });
        });
      }
      attachExport(document.getElementById('topicResult'));

      /* ---- Tạo đề từ đề mẫu ---- */
      document.getElementById('createBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('createFile');
        const status = document.getElementById('createStatus');
        const result = document.getElementById('createResult');
        const output = document.getElementById('createOutput');
        const countEl = document.getElementById('createResultCount');

        if (!fileInput.files.length) {
          status.textContent = 'Vui lòng chọn file .docx';
          return;
        }

        status.textContent = 'Đang tạo đề mới...';
        result.hidden = true;

        try {
          const formData = new FormData();
          formData.append('file', fileInput.files[0]);
          formData.append('count', document.getElementById('createCount').value || 20);
          formData.append('ai_engine', document.getElementById('createEngine').value || activeEngine);

          const res = await fetch('/api/generate-similar-exam', { method: 'POST', body: formData });
          const data = await res.json();

          if (data.ok) {
            createdQuestions = data.generated_questions || [];
            countEl.textContent = createdQuestions.length;
            output.innerHTML = createdQuestions.map((q, i) => `
              <div class="created-question">
                <div class="q-number">Câu ${i + 1}</div>
                <div class="q-content">${q.content || ''}</div>
                <div class="q-options">${(q.options || []).map((o, j) => `<span>${String.fromCharCode(65 + j)}) ${o}</span>`).join(' ')}</div>
                <div class="q-answer">Đáp án: ${q.correct_answer || ''}</div>
              </div>
            `).join('');
            result.hidden = false;
            status.textContent = `Đã tạo ${createdQuestions.length} câu hỏi mới`;

            // Auto save to history
            saveToHistory({
              type: 'create',
              filename: fileInput.files[0].name,
              count: createdQuestions.length,
              questions: createdQuestions,
              timestamp: new Date().toISOString(),
            });
          } else {
            status.textContent = 'Lỗi: ' + (data.error || 'Không thể tạo đề');
          }
        } catch (err) {
          status.textContent = 'Lỗi: ' + err.message;
        }
      });

      document.getElementById('createExportDocx').addEventListener('click', async () => {
        if (!createdQuestions.length) return;
        const formData = new FormData();
        formData.append('samples', createdQuestions.map(q => q.content).join('\n'));
        formData.append('topic', 'exam');
        formData.append('fmt', 'docx');
        const res = await fetch('/export', { method: 'POST', body: formData });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'de_moi.docx';
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('createExportPdf').addEventListener('click', async () => {
        if (!createdQuestions.length) return;
        const formData = new FormData();
        formData.append('samples', createdQuestions.map(q => q.content).join('\n'));
        formData.append('topic', 'exam');
        formData.append('fmt', 'pdf');
        const res = await fetch('/export', { method: 'POST', body: formData });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'de_moi.pdf';
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('createSaveHistory').addEventListener('click', () => {
        if (!createdQuestions.length) return;
        const status = document.getElementById('createStatus');
        status.textContent = 'Đã lưu vào lịch sử!';
      });

      /* ---- Lịch sử sử dụng ---- */
      function saveToHistory(item) {
        usageHistory.unshift(item);
        if (usageHistory.length > 50) usageHistory = usageHistory.slice(0, 50);
        localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
        renderHistory();
      }

      function renderHistory() {
        const list = document.getElementById('historyList');
        if (!usageHistory.length) {
          list.innerHTML = '<p>Chưa có lịch sử.</p>';
          return;
        }
        list.innerHTML = usageHistory.map((h, i) => {
          const date = new Date(h.timestamp).toLocaleString('vi-VN');
          const typeLabel = h.type === 'create' ? 'Tạo đề' : h.type === 'topic' ? 'Tạo theo chủ đề' : 'Khác';
          return `
            <div class="history-item">
              <div class="history-meta">
                <span class="history-type">${typeLabel}</span>
                <span class="history-date">${date}</span>
              </div>
              <div class="history-info">
                ${h.filename ? `<strong>File:</strong> ${h.filename}` : ''}
                <strong>Số câu:</strong> ${h.count || 0}
              </div>
              <div class="history-actions">
                <button class="view-history" data-index="${i}">Xem</button>
                <button class="delete-history" data-index="${i}">Xóa</button>
              </div>
            </div>
          `;
        }).join('');

        list.querySelectorAll('.delete-history').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index);
            usageHistory.splice(idx, 1);
            localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
            renderHistory();
          });
        });

        list.querySelectorAll('.view-history').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index);
            const h = usageHistory[idx];
            if (h && h.questions) {
              alert(`Có ${h.questions.length} câu hỏi.\n\nCâu 1: ${h.questions[0]?.content || 'N/A'}`);
            }
          });
        });
      }

      document.getElementById('historyRefreshBtn').addEventListener('click', () => {
        usageHistory = JSON.parse(localStorage.getItem('usageHistory') || '[]');
        renderHistory();
      });

      document.getElementById('historyClearBtn').addEventListener('click', () => {
        if (!confirm('Xóa toàn bộ lịch sử?')) return;
        usageHistory = [];
        localStorage.setItem('usageHistory', JSON.stringify(usageHistory));
        renderHistory();
        document.getElementById('historyStatus').textContent = 'Đã xóa lịch sử';
      });

      /* ---- Toggle Answers ---- */
      document.getElementById('toggleAnswers').addEventListener('click', () => {
        const content = document.getElementById('answersContent');
        const btn = document.getElementById('toggleAnswers');
        content.hidden = !content.hidden;
        btn.textContent = content.hidden ? 'Hiện đáp án' : 'Ẩn đáp án';
      });

      /* ---- Topic Generate ---- */
      document.getElementById('topicGenerate').addEventListener('click', async () => {
        const statusEl = document.getElementById('topicStatus');
        const outputEl = document.getElementById('topicOutput');
        const resultPanel = document.getElementById('topicResult');
        statusEl.textContent = 'Đang tạo...';
        resultPanel.hidden = false;
        outputEl.innerHTML = '';

        try {
          const formData = new FormData();
          formData.append('subject', topicSubject.value);
          formData.append('topic', document.getElementById('topicTopic').value);
          formData.append('grade', topicGrade.value);
          formData.append('qtype', topicType.value);
          formData.append('count', document.getElementById('topicCount').value || 10);
          formData.append('ai_engine', document.getElementById('topicEngine').value || activeEngine);
          const res = await fetch('/generate-topic', { method: 'POST', body: formData });
          const data = await res.json();
          statusEl.textContent = data.message || '';
          renderQuestions(data.questions || [], outputEl, statusEl, resultPanel);
          // Show answers if available
          const answersSection = document.getElementById('topicAnswers');
          const answersContent = document.getElementById('answersContent');
          if (data.answers) {
            answersContent.textContent = data.answers;
            answersContent.hidden = true;
            answersSection.hidden = false;
            document.getElementById('toggleAnswers').textContent = 'Hiện đáp án';
          } else {
            answersSection.hidden = true;
          }
        } catch (err) {
          statusEl.textContent = 'Lỗi: ' + err.message;
        }
      });

      /* ---- Blob Manager ---- */
      function humanSize(bytes) {
        if (!bytes) return '0 KB';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let idx = 0;
        while (size >= 1024 && idx < units.length - 1) {
          size /= 1024;
          idx += 1;
        }
        return `${size.toFixed(size < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
      }

      function renderBlobManager(blobs) {
        if (!useBlob) return;
        const total = blobs.reduce((sum, b) => sum + (b.size || 0), 0);
        blobCount.textContent = `${blobs.length} file`;
        blobSize.textContent = humanSize(total);
        blobList.innerHTML = blobs
          .map((item) => {
            return `
              <div class="blob-row">
                <div class="blob-name">${item.pathname}</div>
                <div class="blob-size">${humanSize(item.size || 0)}</div>
                <button data-url="${item.url}" class="blob-del">Xóa</button>
              </div>`;
          })
          .join('');
        blobList.querySelectorAll('.blob-del').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const url = btn.dataset.url;
            await fetch('/api/blob/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url }),
            });
            await loadBlobIndex();
          });
        });
      }

      document.getElementById('refreshBlob').addEventListener('click', async () => {
        if (!useBlob) return;
        await loadBlobIndex();
      });

      document.getElementById('exportBlobCsv').addEventListener('click', async () => {
        if (!useBlob) return;
        const blobs = await fetchBlobList();
        const header = 'pathname,size,url';
        const rows = blobs.map((b) => `${b.pathname},${b.size || 0},${b.url}`);
        const content = [header, ...rows].join('\n');
        const blob = new Blob([content], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'blob_samples.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      /* ---- Word to Excel ---- */
      document.getElementById('convertBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('convertFile');
        const status = document.getElementById('convertStatus');

        if (!fileInput.files.length) {
          status.textContent = 'Vui lòng chọn file .docx';
          return;
        }

        status.textContent = 'Đang chuyển đổi...';

        try {
          const formData = new FormData();
          formData.append('file', fileInput.files[0]);

          const res = await fetch('/convert-word-to-excel', { method: 'POST', body: formData });

          if (res.ok) {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileInput.files[0].name.replace('.docx', '.xlsx');
            a.click();
            URL.revokeObjectURL(url);
            status.textContent = 'Đã tải xuống file Excel!';
          } else {
            const data = await res.json();
            status.textContent = 'Lỗi: ' + (data.detail || 'Không thể chuyển đổi');
          }
        } catch (err) {
          status.textContent = 'Lỗi: ' + err.message;
        }
      });

      /* ---- Question Bank ---- */
      let bankPage = 0;
      const bankLimit = 20;

      async function loadBankQuestions() {
        const subject = document.getElementById('bankSubject').value;
        const difficulty = document.getElementById('bankDifficulty').value;
        const search = document.getElementById('bankSearch').value;

        const params = new URLSearchParams();
        params.append('skip', bankPage * bankLimit);
        params.append('limit', bankLimit);
        if (subject) params.append('subject', subject);
        if (difficulty) params.append('difficulty', difficulty);
        if (search) params.append('search', search);

        try {
          const res = await fetch(`/api/questions?${params}`);
          const data = await res.json();

          document.getElementById('bankTotal').textContent = data.total || 0;

          const list = document.getElementById('bankList');
          list.innerHTML = (data.questions || []).map(q => `
            <div class="bank-item" data-id="${q.id}">
              <div class="bank-item-content">
                <strong>${q.subject || 'N/A'}</strong> -
                <span class="difficulty-${q.difficulty || 'medium'}">${q.difficulty || 'medium'}</span>
                <p>${(q.content || '').substring(0, 150)}...</p>
              </div>
              <div class="bank-item-actions">
                <button class="edit-q" data-id="${q.id}">Sửa</button>
                <button class="delete-q" data-id="${q.id}">Xóa</button>
              </div>
            </div>
          `).join('') || '<p>Không có câu hỏi nào.</p>';

          // Attach delete handlers
          list.querySelectorAll('.delete-q').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (!confirm('Xóa câu hỏi này?')) return;
              await fetch(`/api/questions/${btn.dataset.id}`, { method: 'DELETE' });
              loadBankQuestions();
            });
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function loadBankStats() {
        try {
          const res = await fetch('/api/questions/stats');
          const data = await res.json();
          const el = document.getElementById('bankStats');
          el.innerHTML = `<strong>Tổng: ${data.total || 0} câu hỏi</strong>`;
        } catch (err) {
          console.error(err);
        }
      }

      document.getElementById('bankSearchBtn').addEventListener('click', () => {
        bankPage = 0;
        loadBankQuestions();
      });
      document.getElementById('bankRefreshBtn').addEventListener('click', () => {
        bankPage = 0;
        loadBankQuestions();
        loadBankStats();
      });

      /* ---- Init ---- */
      loadSampleFolders();
      loadSubjects();
      loadBuildInfo();
      loadEngines();
      loadSettings();
      loadBankStats();
      loadBankQuestions();
      renderHistory();
    </script>
  </body>
</html>
